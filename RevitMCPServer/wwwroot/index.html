<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revit MCP Dashboard</title>
  <style>
    :root { --ink:#111; --muted:#666; --bd:#ddd; --card:#fafafa; --err:#b00020; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: var(--ink); }
    header { margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 12px 0 8px; }
    small { color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .card { border: 1px solid var(--bd); border-radius: 8px; padding: 12px; background: var(--card); }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border: 1px solid var(--bd); padding: 6px 8px; text-align: left; }
    th { background: #f2f4f7; color: #333; }
    .reports a { display: inline-block; margin-right: 12px; margin-bottom: 6px; }
    .error { color: var(--err); white-space: pre-wrap; }
    .ts { color: var(--muted); font-size: 12px; margin-left: 8px; }
    .right { text-align: right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Segoe UI Mono", monospace; }

    details.debug { margin-top: 20px; }
    details.debug summary { cursor: pointer; }
    pre { background:#0b1020; color:#e8ecff; padding:10px; border-radius:8px; overflow:auto; }
  </style>
  <script>
    // ============ Tiny helpers ============
    const sleep = (ms)=> new Promise(s=>setTimeout(s, ms));
    const fmt = (v)=> (typeof v === 'number') ? v.toLocaleString() : (v ?? '');

    // Debug sink
    const Debug = {
      push(label, obj) {
        console.log("[DBG]", label, obj);
        const el = document.getElementById('dbg');
        const block = document.createElement('div');
        block.innerHTML = `<div><strong>${label}</strong></div><pre>${escapeHtml(JSON.stringify(obj, null, 2))}</pre>`;
        el.appendChild(block);
      }
    };
    const escapeHtml = (s)=> s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // ============ JSON-RPC enqueue + await ============
    async function callRpcAndAwait(method, params = {}, waitMs = 15000) {
      const reqId = `ui:${method}:${Date.now()}:${Math.random().toString(36).slice(2)}`;

      // 1) Enqueue at /rpc/{method}
      const res = await fetch(`/rpc/${encodeURIComponent(method)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc:'2.0', id: reqId, params })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status} on /rpc/${method}`);
      const data = await res.json();
      Debug.push(`rpc/${method} enqueue response`, data);

      // JSON-RPC error short-circuit
      if (data && data.error) throw new Error(data.error.message || `RPC error (${method})`);

      // Direct-result (e.g., excel_* direct mode)
      if (data && data.jsonrpc && typeof data.result !== 'undefined') {
        const r = data.result;
        if (r && r.ok !== undefined) return r;        // typical { ok, ... }
        if (r && r.queued) return await awaitResult(reqId, r.jobId, waitMs, method);
        return r;                                      // unexpected but acceptable
      }

      // Non-JSON-RPC shaped but has queued hint
      const payload = data || {};
      if (payload.queued) return await awaitResult(reqId, payload.jobId, waitMs, method);
      return payload;
    }

    // 2) Poll /get_result (prefer jobId; fallback to FIFO)
    async function awaitResult(reqId, jobId, waitMs, method) {
      const deadline = Date.now() + waitMs;
      while (Date.now() < deadline) {
        const url = jobId ? (`/get_result?jobId=${encodeURIComponent(jobId)}`) : '/get_result';
        const r = await fetch(url, { method: 'GET', cache: 'no-store' });
        if (r.status === 204) { await sleep(300); continue; }
        if (!r.ok)           { await sleep(300); continue; }

        const txt = await r.text();
        if (!txt)            { await sleep(300); continue; }

        let obj = null;
        try { obj = JSON.parse(txt); } catch { /* keep polling */ }
        Debug.push(`get_result ${jobId ? '(by jobId)' : '(fifo)'} raw`, obj ?? txt);

        // === 受け取り形の分岐 ===
        if (obj && obj.error) {
          const msg = obj.error.message || `RPC error (${method})`;
          throw new Error(msg);
        }

        // (A) JSON-RPC envelope → そのまま result を返す
        if (obj && obj.jsonrpc && typeof obj.result !== 'undefined') {
          return obj.result;
        }

        // (B) リクエストID一致（稀）→ 同上
        if (obj && obj.id === reqId) {
          return (typeof obj.result !== 'undefined') ? obj.result : obj;
        }

        // (C) ここが今回の強化: 素のオブジェクト（JSON-RPCでない）が返る場合
        //     代表的には { ok:true, projectName:..., ... } など
        if (obj && (obj.ok !== undefined || obj.projectName !== undefined || obj.revitVersion !== undefined)) {
          return obj;
        }

        // それ以外は自分の結果ではないか、未整形 → 継続
        await sleep(250);
      }
      throw new Error(`Timeout waiting result (${method})`);
    }

    // ============ Page load ============
    async function load() {
      const err = document.getElementById('err');
      const ts = document.getElementById('ts');
      err.textContent = '';

      try {
        // ---- Connectivity (optional) ----
        try {
          const h = await fetch('/health', { cache:'no-store' });
          const hj = await h.json().catch(()=> ({}));
          Debug.push('health', hj);
        } catch {}

        // ---- Project Summary ----
        const summary = await callRpcAndAwait('get_project_summary', {}, 20000);
        Debug.push('get_project_summary final', summary);

        if (!summary || summary.ok === false) {
          const msg = (summary && summary.msg) ? summary.msg : 'get_project_summary failed';
          throw new Error(msg);
        }

        document.getElementById('proj').innerHTML = `
          <div><strong>${summary.projectName || ''}</strong></div>
          <div class="mono"><small>${fmt(summary.revitVersion) || ''}</small></div>
          <div><small class="mono">${fmt(summary.docPath) || ''}</small></div>
          <div><small>Cloud: ${fmt(summary.isCloudModel)}</small></div>
          <div><small>Unit: ${fmt(summary.unitSystem)}</small></div>`;

        document.getElementById('stats').innerHTML = `
          <div>Levels: <strong>${fmt(summary.levels)}</strong></div>
          <div>Views: <strong>${fmt(summary.views)}</strong></div>
          <div>Categories: <strong>${fmt(summary.categories)}</strong></div>
          <div>Phases: <strong>${(summary.phases || []).length}</strong></div>`;

        document.getElementById('work').innerHTML = `
          <div>Workshared: <strong>${fmt(summary.isWorkshared)}</strong></div>
          <div>Worksets: <strong>${fmt(summary.worksets)}</strong></div>
          <div>Design Options: <strong>${fmt(summary.designOptions)}</strong></div>
          <div>Warnings: <strong>${fmt(summary.warnings)}</strong></div>`;

        // ---- Levels (preview) ----
        try {
          const lv = await callRpcAndAwait('list_levels_simple', {}, 20000);
          Debug.push('list_levels_simple', lv);
          const tb = document.querySelector('#levels tbody');
          tb.innerHTML = '';
          (lv.items || []).slice(0, 10).forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${fmt(x.name)}</td><td class="right">${fmt(x.elevation)}</td><td class="right">${fmt(x.id)}</td>`;
            tb.appendChild(tr);
          });
          if (!(lv.items||[]).length) tb.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
        } catch (e) {
          document.querySelector('#levels tbody').innerHTML = `<tr><td colspan="3" class="error">${e.message || e}</td></tr>`;
        }

        // ---- Rooms by Level (preview) ----
        try {
          const rm = await callRpcAndAwait('summarize_rooms_by_level', {}, 20000);
          Debug.push('summarize_rooms_by_level', rm);
          const tb = document.querySelector('#rooms tbody');
          tb.innerHTML = '';
          (rm.items || []).slice(0, 10).forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${fmt(r.levelName) || '(No level)'}</td><td class="right">${fmt(r.rooms)}</td><td class="right">${fmt(r.totalAreaM2)}</td>`;
            tb.appendChild(tr);
          });
          if (!(rm.items||[]).length) tb.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
        } catch (e) {
          document.querySelector('#rooms tbody').innerHTML = `<tr><td colspan="3" class="error">${e.message || e}</td></tr>`;
        }

        // ---- Elements & Used Types (preview) ----
        try {
          const [elems, types] = await Promise.allSettled([
            callRpcAndAwait('summarize_elements_by_category', { includeAnnotations:false }, 25000),
            callRpcAndAwait('summarize_family_types_by_category', {}, 25000) // optional
          ]);
          Debug.push('summarize_elements_by_category', elems);
          Debug.push('summarize_family_types_by_category', types);

          const map = new Map();
          if (elems.status === 'fulfilled' && elems.value && elems.value.ok) {
            for (const it of (elems.value.items || [])) map.set(it.categoryName, { elements: it.count, types: null });
          }
          if (types.status === 'fulfilled' && types.value && types.value.ok) {
            for (const it of (types.value.items || [])) {
              const cur = map.get(it.categoryName) || { elements: null, types: null };
              cur.types = it.typeCount;
              map.set(it.categoryName, cur);
            }
          }

          const tb = document.querySelector('#cats tbody');
          tb.innerHTML = '';
          const rows = Array.from(map.entries())
            .sort((a,b)=> (b[1].elements||0) - (a[1].elements||0))
            .slice(0, 12);

          if (!rows.length) {
            tb.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
          } else {
            for (const [k,v] of rows) {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${k}</td><td class="right">${v.elements==null?'—':fmt(v.elements)}</td><td class="right">${v.types==null?'(N/A)':fmt(v.types)}</td>`;
              tb.appendChild(tr);
            }
          }
        } catch (e) {
          document.querySelector('#cats tbody').innerHTML = `<tr><td colspan="3" class="error">${e.message || e}</td></tr>`;
        }

        ts.textContent = `Updated: ${new Date().toLocaleString()}`;
      } catch (e) {
        document.getElementById('err').textContent = (e && e.message) ? e.message : String(e || 'Unknown error');
      }
    }

    addEventListener('DOMContentLoaded', load);
  </script>
</head>
<body>
  <header>
    <h1>Revit MCP Dashboard <span id="ts" class="ts">—</span></h1>
    <div id="err" class="error"></div>
  </header>

  <section class="grid">
    <div class="card"><h2>Project</h2><div id="proj">Loading…</div></div>
    <div class="card"><h2>Stats</h2><div id="stats">Loading…</div></div>
    <div class="card"><h2>Worksharing</h2><div id="work">Loading…</div></div>
  </section>

  <section class="grid" style="margin-top:16px;">
    <div class="card" style="grid-column: 1 / -1;">
      <h2>Levels (preview)</h2>
      <table id="levels">
        <thead><tr><th>Name</th><th class="right">Elevation (m)</th><th class="right">Id</th></tr></thead>
        <tbody><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Rooms & Areas by Level (preview)</h2>
      <table id="rooms">
        <thead><tr><th>Level</th><th class="right">Rooms</th><th class="right">Total Area (m²)</th></tr></thead>
        <tbody><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Elements & Used Types (preview)</h2>
      <table id="cats">
        <thead><tr><th>Category</th><th class="right">Elements</th><th class="right">Used Types</th></tr></thead>
        <tbody><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <h2 style="margin-top:16px;">Reports</h2>
  <div class="reports">
    <a href="report_rooms.html">Rooms by Level</a>
    <a href="report_categories.html">Elements by Category</a>
    <a href="report_levels.html">Levels</a>
    <a href="report_warnings.html">Warnings</a>
  </div>

  <details class="debug">
    <summary>Debug (click to open)</summary>
    <div id="dbg"></div>
  </details>
</body>
</html>
