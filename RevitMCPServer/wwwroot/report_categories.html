<!doctype html>
<html lang="ja"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elements by Category</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
    caption { text-align: left; margin-bottom: 8px; font-weight: 600; }
    .error { color: #b00020; }
  </style>
  <script>
    async function rpc(method, params={}){
      const reqId = `ui:${method}:${Date.now()}:${Math.random().toString(36).slice(2)}`;
      const res = await fetch(`/rpc/${method}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({jsonrpc:'2.0', id:reqId, method, params})});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(data && data.error) throw new Error(data.error.message||'RPC error');
      let payload = (data && data.jsonrpc && typeof data.result !== 'undefined') ? data.result : data;
      if(payload && payload.queued){
        const deadline = Date.now()+30000;
        while(true){
          const r = await fetch(payload.jobId ? (`/get_result?jobId=${encodeURIComponent(payload.jobId)}`) : '/get_result');
          if(r.status===204){ if(Date.now()>deadline) throw new Error('RPC timeout'); await new Promise(s=>setTimeout(s,300)); continue; }
          if(!r.ok){ if(Date.now()>deadline) throw new Error('RPC failed'); await new Promise(s=>setTimeout(s,300)); continue; }
          const txt=await r.text(); let obj; try{ obj=JSON.parse(txt);}catch{continue}
          if(payload.jobId){ if(obj && obj.jsonrpc && (typeof obj.result!=='undefined')) return obj.result; }
          else if(obj && obj.id===reqId){ if(obj.error) throw new Error(obj.error.message||'RPC error'); return (typeof obj.result!=='undefined')?obj.result:obj; }
        }
      }
      return payload;
    }
    async function load(){
      const tbody=document.querySelector('#cat tbody'); const tbody2=document.querySelector('#types tbody'); const err=document.getElementById('err'); err.textContent='';
      try{
        const cats = await rpc('summarize_elements_by_category', { includeAnnotations:false });
        if(!cats.ok) throw new Error(cats.msg||'RPC failed');
        document.getElementById('total').textContent = `Total elements: ${cats.total}`;
        (cats.items||[]).forEach(r=>{
          const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.categoryName}</td><td>${r.count}</td>`; tbody.appendChild(tr);
        });
        try{
          const types = await rpc('summarize_family_types_by_category', {});
          if(types.ok){
            (types.items||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.categoryName}</td><td>${r.typeCount}</td>`; tbody2.appendChild(tr); });
          } else {
            tbody2.innerHTML = `<tr><td colspan="2">N/A</td></tr>`;
          }
        }catch{ tbody2.innerHTML = `<tr><td colspan="2">N/A</td></tr>`; }
      }catch(e){ err.textContent=e.message||String(e); }
    }
    addEventListener('DOMContentLoaded', load);
  </script>
</head>
<body>
  <h1>Elements and Types by Category</h1>
  <div id="err" class="error"></div>
  <h2>Elements</h2>
  <table id="cat">
    <caption id="total">Totalsâ€¦</caption>
    <thead><tr><th>Category</th><th>Count</th></tr></thead>
    <tbody></tbody>
  </table>
  <h2>Used Types</h2>
  <table id="types">
    <thead><tr><th>Category</th><th>Used Types</th></tr></thead>
    <tbody></tbody>
  </table>
  <p><a href="index.html">Back</a></p>
</body></html>
