// ================================================================\n// File: UI/RibbonPortUi.cs\n// Tab: RevitMCPServer\n// Panels:\n//   - RevitMCPServer（既存）: Port:#### / Start Server(緑) / Stop Server(赤) / Start Bridge(青) / Stop Bridge(橙)\n//   - Developer（拡張）   : Open Addin Folder / Open Logs Folder / Open Settings / Reload Settings\n// ================================================================\n#nullable enable\nusing Autodesk.Revit.DB;\nusing Autodesk.Revit.UI;\nusing System;\nusing System.Collections.Generic;\nusing System.Globalization;\nusing System.IO;\nusing System.Linq;\nusing System.Reflection;\nusing Imaging = System.Windows.Media.Imaging;\n// WPF\nusing Media = System.Windows.Media;\n\nnamespace RevitMCPAddin.UI\n{\n    public static class RibbonPortUi\n    {\n        // ---- Tab / Panels ----\n        public const string TabName = "RevitMCPServer";\n        public const string PanelName = "RevitMCPServer";   // 既存\n        public const string DevPanelName = "Developer";     // 追加\n\n        // ---- Port ----\n        public const string ButtonNamePort = "ShowPort";\n        public const string ButtonClassPort = "RevitMCPAddin.UI.ShowPortCommand";\n\n        // ---- Server ----\n        public const string ButtonNameStartServer = "StartServer";\n        public const string ButtonNameStopServer = "StopServer";\n        public const string ButtonClassStartServer = "RevitMCPAddin.Commands.ServerControl.StartMcpServerCommand";\n        public const string ButtonClassStopServer = "RevitMCPAddin.Commands.ServerControl.StopMcpServerCommand";\n\n        // ---- Bridge（色変更：緑→青、赤→オレンジ）----\n        public const string ButtonNameStartBridge = "StartBridge";\n        public const string ButtonNameStopBridge = "StopBridge";\n        // ★ 既存の Bridge コマンド クラス名に合わせてください（下は一般的な例）\n        public const string ButtonClassStartBridge = "RevitMCPAddin.Commands.BridgeControl.StartBridgeCommand";\n        public const string ButtonClassStopBridge = "RevitMCPAddin.Commands.BridgeControl.StopBridgeCommand";\n\n        // ---- Developer: 「開く」系 + 設定系（拡張）----\n        public const string ButtonNameOpenAddin = "OpenAddinFolder";\n        public const string ButtonNameOpenLogs = "OpenLogsFolder";\n        public const string ButtonClassOpenAddin = "RevitMCPAddin.Commands.Dev.OpenAddinFolderCommand";\n        public const string ButtonClassOpenLogs = "RevitMCPAddin.Commands.Dev.OpenLogFolderCommand";\n\n        // ★ 新規: Settings 操作用\n        public const string ButtonNameOpenSettings = "OpenSettings";\n        public const string ButtonNameReloadSettings = "ReloadSettings";\n        public const string ButtonClassOpenSettings = "RevitMCPAddin.Commands.SystemOps.OpenSettingsCommand";\n        public const string ButtonClassReloadSettings = "RevitMCPAddin.Commands.SystemOps.ReloadServerSettingsCommand";\n\n\n        private static int _currentPort;\n\n        public static void Setup(UIControlledApplication app, int? port = null, string? iconDir = null)\n        {\n            _currentPort = port ?? PortSettings.GetPort();\n\n            try { app.CreateRibbonTab(TabName); } catch { /* 既存なら無視 */ }\n\n            // ===== 既存の RevitMCPServer パネル =====\n            var panel = app.GetRibbonPanels(TabName).FirstOrDefault(p => p.Name == PanelName)\n                        ?? app.CreateRibbonPanel(TabName, PanelName);\n\n            string asm = Assembly.GetExecutingAssembly().Location;\n\n            // --- Port ---\n            var portBtn = EnsurePushButton(panel, ButtonNamePort, "Port:" + _currentPort, asm, ButtonClassPort);\n            portBtn.ToolTip = "MCP サーバーの待ち受けポート：" + _currentPort;\n            portBtn.LongDescription = "外部 MCP サーバーとの通信に使用する現在のポート番号。";\n            {\n                var base16 = PortIconBuilder.ResolveIconPath(iconDir, "port_base_16.png");\n                var base32 = PortIconBuilder.ResolveIconPath(iconDir, "port_base_32.png");\n                portBtn.Image = PortIconBuilder.BuildPortBadge(_currentPort, 16, base16);\n                portBtn.LargeImage = PortIconBuilder.BuildPortBadge(_currentPort, 32, base32);\n            }\n\n            // =============== Server（緑／赤） ===============\n            {\n                // Start Server（緑）\n                var startBtn = EnsurePushButton(panel, ButtonNameStartServer, "Start Server", asm, ButtonClassStartServer);\n                startBtn.ToolTip = "MCP サーバーを開始します。";\n                var i16 = PortIconBuilder.ResolveIconPath(iconDir, "server_start_green_16.png");\n                var i32 = PortIconBuilder.ResolveIconPath(iconDir, "server_start_green_32.png");\n                startBtn.Image = PortIconBuilder.TryLoadBitmapAsImage(i16) ?? PortIconBuilder.BuildTriangleIcon(16,\n                                            fill: Media.Color.FromRgb(12, 158, 93),   // 緑\n                                            stroke: Media.Color.FromRgb(0, 100, 60));\n                startBtn.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(i32) ?? PortIconBuilder.BuildTriangleIcon(32,\n                                            fill: Media.Color.FromRgb(12, 158, 93),\n                                            stroke: Media.Color.FromRgb(0, 100, 60));\n\n                // Stop Server（赤）\n                var stopBtn = EnsurePushButton(panel, ButtonNameStopServer, "Stop Server", asm, ButtonClassStopServer);\n                stopBtn.ToolTip = "MCP サーバーを停止します。";\n                var j16 = PortIconBuilder.ResolveIconPath(iconDir, "server_stop_red_16.png");\n                var j32 = PortIconBuilder.ResolveIconPath(iconDir, "server_stop_red_32.png");\n                stopBtn.Image = PortIconBuilder.TryLoadBitmapAsImage(j16) ?? PortIconBuilder.BuildSquareIcon(16,\n                                            fill: Media.Color.FromRgb(225, 38, 38),   // 赤\n                                            stroke: Media.Color.FromRgb(140, 0, 0));\n                stopBtn.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(j32) ?? PortIconBuilder.BuildSquareIcon(32,\n                                            fill: Media.Color.FromRgb(225, 38, 38),\n                                            stroke: Media.Color.FromRgb(140, 0, 0));\n            }\n\n            // =============== Bridge（青／オレンジ） ===============\n            {\n                // Start Bridge（青）\n                var startBtn = EnsurePushButton(panel, ButtonNameStartBridge, "Start Bridge", asm, ButtonClassStartBridge);\n                startBtn.ToolTip = "Bridge を開始します。";\n                var i16 = PortIconBuilder.ResolveIconPath(iconDir, "bridge_start_blue_16.png");\n                var i32 = PortIconBuilder.ResolveIconPath(iconDir, "bridge_start_blue_32.png");\n                startBtn.Image = PortIconBuilder.TryLoadBitmapAsImage(i16) ?? PortIconBuilder.BuildTriangleIcon(16,\n                                            fill: Media.Color.FromRgb(45, 120, 220),  // 青\n                                            stroke: Media.Color.FromRgb(20, 70, 160));\n                startBtn.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(i32) ?? PortIconBuilder.BuildTriangleIcon(32,\n                                            fill: Media.Color.FromRgb(45, 120, 220),\n                                            stroke: Media.Color.FromRgb(20, 70, 160));\n\n                // Stop Bridge（オレンジ）\n                var stopBtn = EnsurePushButton(panel, ButtonNameStopBridge, "Stop Bridge", asm, ButtonClassStopBridge);\n                stopBtn.ToolTip = "Bridge を停止します。";\n                var j16 = PortIconBuilder.ResolveIconPath(iconDir, "bridge_stop_orange_16.png");\n                var j32 = PortIconBuilder.ResolveIconPath(iconDir, "bridge_stop_orange_32.png");\n                stopBtn.Image = PortIconBuilder.TryLoadBitmapAsImage(j16) ?? PortIconBuilder.BuildSquareIcon(16,\n                                            fill: Media.Color.FromRgb(240, 140, 0),   // オレンジ\n                                            stroke: Media.Color.FromRgb(180, 90, 0));\n                stopBtn.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(j32) ?? PortIconBuilder.BuildSquareIcon(32,\n                                            fill: Media.Color.FromRgb(240, 140, 0),\n                                            stroke: Media.Color.FromRgb(180, 90, 0));\n            }\n\n            // ===== Developer パネル（拡張）=====\n            var devPanel = app.GetRibbonPanels(TabName).FirstOrDefault(p => p.Name == DevPanelName)\n                           ?? app.CreateRibbonPanel(TabName, DevPanelName);\n\n            var btnOpenAddin = EnsurePushButton(devPanel, ButtonNameOpenAddin, "Open\nAddin Folder", asm, ButtonClassOpenAddin);\n            btnOpenAddin.ToolTip = "アドインDLLが配置されているフォルダを開きます。";\n            {\n                var a16 = PortIconBuilder.ResolveIconPath(iconDir, "open_folder_16.png");\n                var a32 = PortIconBuilder.ResolveIconPath(iconDir, "open_folder_32.png");\n                btnOpenAddin.Image = PortIconBuilder.TryLoadBitmapAsImage(a16) ?? PortIconBuilder.BuildFolderIcon(16);\n                btnOpenAddin.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(a32) ?? PortIconBuilder.BuildFolderIcon(32);\n            }\n\n            var btnOpenLogs = EnsurePushButton(devPanel, ButtonNameOpenLogs, "Open\nLogs Folder", asm, ButtonClassOpenLogs);\n            btnOpenLogs.ToolTip = "%LOCALAPPDATA%\\RevitMCP\\logs を開きます。";\n            {\n                var l16 = PortIconBuilder.ResolveIconPath(iconDir, "open_logs_16.png");\n                var l32 = PortIconBuilder.ResolveIconPath(iconDir, "open_logs_32.png");\n                btnOpenLogs.Image = PortIconBuilder.TryLoadBitmapAsImage(l16) ?? PortIconBuilder.BuildFolderIcon(16, isLogs: true);\n                btnOpenLogs.LargeImage = PortIconBuilder.TryLoadBitmapAsImage(l32) ?? PortIconBuilder.BuildFolderIcon(32, isLogs: true);\n            }\n\n            // ★ 新規: Open Settings / Reload Settings\n            var btnOpenSettings = EnsurePushButton(devPanel, ButtonNameOpenSettings, "Open\nSettings", asm, ButtonClassOpenSettings);\n            btnOpenSettings.ToolTip = "MCPサーバーの settings.json を開きます。";\n            {\n                btnOpenSettings.Image = PortIconBuilder.BuildFolderIcon(16);\n                btnOpenSettings.LargeImage = PortIconBuilder.BuildFolderIcon(32);\n            }\n\n            var btnReloadSettings = EnsurePushButton(devPanel, ButtonNameReloadSettings, "Reload\nSettings", asm, ButtonClassReloadSettings);\n            btnReloadSettings.ToolTip = "サーバーに設定再読込（/rpc/reload_config）を要求します。";\n            {\n                // 既存ビルダーを流用（色だけ変える）\n                btnReloadSettings.Image = PortIconBuilder.BuildTriangleIcon(16,\n                    fill: Media.Color.FromRgb(120, 120, 120), stroke: Media.Color.FromRgb(60, 60, 60));\n                btnReloadSettings.LargeImage = PortIconBuilder.BuildTriangleIcon(32,\n                    fill: Media.Color.FromRgb(120, 120, 120), stroke: Media.Color.FromRgb(60, 60, 60));\n            }\n        }\n\n        public static void UpdatePort(UIControlledApplication app, int newPort, string? iconDir = null)\n        {\n            _currentPort = newPort;\n\n            var panel = app.GetRibbonPanels(TabName).FirstOrDefault(p => p.Name == PanelName);\n            if (panel == null) { Setup(app, newPort, iconDir); return; }\n\n            var btn = panel.GetItems().OfType<PushButton>().FirstOrDefault(b => b.Name == ButtonNamePort);\n            if (btn == null) { Setup(app, newPort, iconDir); return; }\n\n            btn.ItemText = "Port:" + newPort;\n            btn.ToolTip = "MCP サーバーの待ち受けポート：" + newPort;\n\n            var base16 = PortIconBuilder.ResolveIconPath(iconDir, "port_base_16.png");\n            var base32 = PortIconBuilder.ResolveIconPath(iconDir, "port_base_32.png");\n            btn.Image = PortIconBuilder.BuildPortBadge(newPort, 16, base16);\n            btn.LargeImage = PortIconBuilder.BuildPortBadge(newPort, 32, base32);\n        }\n\n        public static void UpdatePort(UIApplication uiapp, int newPort, string? iconDir = null)\n        {\n            _currentPort = newPort;\n            try
            {
                Environment.SetEnvironmentVariable("REVIT_MCP_PORT", newPort.ToString());
                RevitMCPAddin.Core.PortLocator.SaveCurrentPort(newPort);
            }
            catch (Exception ex)
            {
                RevitMCPAddin.Core.RevitLogger.Warn($"Set REVIT_MCP_PORT/SaveCurrentPort failed: {ex.Message}");
            }
\n            var uica = RevitMCPAddin.AppServices.UIControlledApp;\n            if (uica != null)\n            {\n                try { UpdatePort(uica, newPort, iconDir); return; }\n                catch { /* 最低限: 環境変数は更新済み */ }\n            }\n        }\n\n        private static PushButton EnsurePushButton(RibbonPanel panel, string name, string text, string assemblyPath, string className)\n        {\n            var exists = panel.GetItems().OfType<PushButton>().FirstOrDefault(b => b.Name == name);\n            if (exists != null) { exists.ItemText = text; return exists; }\n\n            var data = new PushButtonData(name, text, assemblyPath, className);\n            var created = panel.AddItem(data) as PushButton;\n            return created ?? throw new InvalidOperationException("Failed to create PushButton: " + name);\n        }\n\n        // Additional panel for CPU priority toggling\n        public static void AddPerformancePanel(UIControlledApplication app)\n        {\n            try { app.CreateRibbonTab(TabName); } catch { }\n            var panel = app.GetRibbonPanels(TabName).FirstOrDefault(p => p.Name == "Performance")\n                        ?? app.CreateRibbonPanel(TabName, "Performance");\n\n            string asm = Assembly.GetExecutingAssembly().Location;\n\n            var btnHigh = EnsurePushButton(panel, "SetPriorityHigh", "CPU High", asm, "RevitMCPAddin.Commands.SystemOps.SetPriorityHighCommand");\n            btnHigh.ToolTip = "Revitプロセスの CPU 優先度を High に設定します。";\n            btnHigh.Image = PortIconBuilder.BuildTriangleIcon(16, fill: Media.Color.FromRgb(255, 215, 0), stroke: Media.Color.FromRgb(180, 150, 0));\n            btnHigh.LargeImage = PortIconBuilder.BuildTriangleIcon(32, fill: Media.Color.FromRgb(255, 215, 0), stroke: Media.Color.FromRgb(180, 150, 0));\n\n            var btnNorm = EnsurePushButton(panel, "SetPriorityNormal", "CPU Normal", asm, "RevitMCPAddin.Commands.SystemOps.SetPriorityNormalCommand");\n            btnNorm.ToolTip = "Revitプロセスの CPU 優先度を Normal に設定します。";\n            btnNorm.Image = PortIconBuilder.BuildTriangleIcon(16, fill: Media.Color.FromRgb(120, 120, 120), stroke: Media.Color.FromRgb(60, 60, 60));\n            btnNorm.LargeImage = PortIconBuilder.BuildTriangleIcon(32, fill: Media.Color.FromRgb(120, 120, 120), stroke: Media.Color.FromRgb(60, 60, 60));\n        }\n    }\n\n    //================================================================\n    // ShowPort & PortSettings\n    //================================================================\n    [Autodesk.Revit.Attributes.Transaction(Autodesk.Revit.Attributes.TransactionMode.ReadOnly)]\n    public class ShowPortCommand : IExternalCommand\n    {\n        public Result Execute(ExternalCommandData data, ref string message, ElementSet elements)\n        {\n            int port = PortSettings.GetPort();\n            TaskDialog.Show("MCP Server", "現在のポート番号は " + port + " です。");\n            return Result.Succeeded;\n        }\n    }\n\n    public static class PortSettings\n    {\n        public static int GetPort()\n        {\n            var env = Environment.GetEnvironmentVariable("REVIT_MCP_PORT");\n            if (int.TryParse(env, out var p) && p > 0 && p < 65536) return p;\n            return 5210;\n        }\n    }\n\n    //================================================================\n    // Icon Builder（既存）\n    //================================================================\n    internal static class PortIconBuilder\n    {\n        public static string? ResolveIconPath(string? iconDir, string fileName)\n        {\n            string? dllDir = null;\n            try { dllDir = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location); }\n            catch (Exception ex)\n            {\n                RevitMCPAddin.Core.RevitLogger.Warn($"GetExecutingAssembly.Location failed: {ex.Message}");\n            }\n\n            var common = Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData);\n            var roaming = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);\n\n            IEnumerable<string> Candidates()\n            {\n                if (!string.IsNullOrWhiteSpace(iconDir))\n                {\n                    yield return Path.Combine(iconDir, fileName);\n                    yield return Path.Combine(iconDir, "icons", fileName);\n                }\n                if (!string.IsNullOrWhiteSpace(dllDir))\n                {\n                    yield return Path.Combine(dllDir, fileName);\n                    yield return Path.Combine(dllDir, "icons", fileName);\n                }\n                foreach (var ver in new[] { "2025", "2024", "2023" })\n                {\n                    yield return Path.Combine(common, "Autodesk", "Revit", "Addins", ver, "RevitMCPAddin", "icons", fileName);\n                    yield return Path.Combine(roaming, "Autodesk", "Revit", "Addins", ver, "RevitMCPAddin", "icons", fileName);\n                }\n            }\n            try { return Candidates().FirstOrDefault(File.Exists); }\n            catch (Exception ex)\n            {\n                RevitMCPAddin.Core.RevitLogger.Warn($"ResolveIconPath Candidates evaluation failed: {ex.Message}");\n                return null;\n            }\n        }\n\n        public static Media.ImageSource? TryLoadBitmapAsImage(string? path)\n        {\n            if (string.IsNullOrWhiteSpace(path) || !File.Exists(path)) return null;\n\n            try\n            {\n                var bi = new Imaging.BitmapImage();\n                bi.BeginInit();\n                bi.UriSource = new Uri(path, UriKind.Absolute);\n                bi.CacheOption = Imaging.BitmapCacheOption.OnLoad;\n                bi.CreateOptions = Imaging.BitmapCreateOptions.IgnoreImageCache;\n                bi.EndInit();\n                bi.Freeze();\n                return bi;\n            }\n            catch (Exception ex)\n            {\n                RevitMCPAddin.Core.RevitLogger.Warn($"TryLoadBitmapAsImage primary load failed for '{path}': {ex.Message}");\n                try\n                {\n                    using var fs = File.OpenRead(path);\n                    var frame = Imaging.BitmapFrame.Create(fs, Imaging.BitmapCreateOptions.None, Imaging.BitmapCacheOption.OnLoad);\n                    frame.Freeze();\n                    return frame;\n                }\n                catch (Exception ex2)\n                {\n                    RevitMCPAddin.Core.RevitLogger.Warn($"TryLoadBitmapAsImage fallback failed for '{path}': {ex2.Message}");\n                    return null;\n                }\n            }\n        }\n\n        // Port 数字バッジ\n        public static Media.ImageSource BuildPortBadge(int port, int sizePx, string? basePngPath = null)\n        {\n            var baseImg = TryLoadBitmapAsImage(basePngPath);\n\n            double padding = sizePx <= 16 ? 2.0 : Math.Max(3.0, sizePx * 0.10);\n            string text = port.ToString(CultureInfo.InvariantCulture);\n\n            var dv = new Media.DrawingVisual();\n            using (var dc = dv.RenderOpen())\n            {\n                if (baseImg != null)\n                {\n                    dc.DrawImage(baseImg, new System.Windows.Rect(0, 0, sizePx, sizePx));\n                }\n                else\n                {\n                    var plate = new Media.RadialGradientBrush(\n                        Media.Color.FromRgb(34, 34, 34),\n                        Media.Color.FromRgb(60, 60, 60))\n                    { Center = new System.Windows.Point(0.35, 0.35), RadiusX = 0.9, RadiusY = 0.9 };\n                    var borderPen = new Media.Pen(new Media.SolidColorBrush(Media.Color.FromRgb(0, 0, 0)), sizePx * 0.06);\n                    borderPen.Freeze();\n                    dc.DrawEllipse(plate, borderPen,\n                        new System.Windows.Point(sizePx / 2.0, sizePx / 2.0),\n                        sizePx * 0.48, sizePx * 0.48);\n                }\n\n                var typeface = new Media.Typeface(new Media.FontFamily("Segoe UI"),\n                    System.Windows.FontStyles.Normal, System.Windows.FontWeights.Bold, System.Windows.FontStretches.Normal);\n\n                double maxW = sizePx - padding * 2;\n                double maxH = sizePx - padding * 2;\n                double fontSize = sizePx * (sizePx <= 16 ? 0.70 : 0.62);\n\n                double MeasureWidth(double fs)\n                {\n                    var ft = new System.Windows.Media.FormattedText(\n                        text, CultureInfo.InvariantCulture, System.Windows.FlowDirection.LeftToRight, typeface, fs, Media.Brushes.White, 1.0);\n                    return Math.Max(ft.Width, ft.Height * 0.9);\n                }\n                while (fontSize > 2 && MeasureWidth(fontSize) > Math.Min(maxW, maxH)) fontSize -= 0.5;\n\n                var mainBrush = Media.Brushes.White;\n                var strokeBrush = new Media.SolidColorBrush(Media.Color.FromArgb(230, 0, 0, 0));\n                strokeBrush.Freeze();\n\n                var ftMain = new System.Windows.Media.FormattedText(text, CultureInfo.InvariantCulture, System.Windows.FlowDirection.LeftToRight, typeface, fontSize, mainBrush, 1.0);\n                double x = (sizePx - ftMain.Width) / 2.0;\n                double y = (sizePx - ftMain.Height) / 2.0;\n\n                for (int dx = -1; dx <= 1; dx++)\n                    for (int dy = -1; dy <= 1; dy++)\n                    {\n                        if (dx == 0 && dy == 0) continue;\n                        var ftStroke = new System.Windows.Media.FormattedText(text, CultureInfo.InvariantCulture, System.Windows.FlowDirection.LeftToRight, typeface, fontSize, strokeBrush, 1.0);\n                        dc.DrawText(ftStroke, new System.Windows.Point(x + dx, y + dy));\n                    }\n\n                dc.DrawText(ftMain, new System.Windows.Point(x, y));\n            }\n\n            var rtb = new Imaging.RenderTargetBitmap(sizePx, sizePx, 96, 96, Media.PixelFormats.Pbgra32);\n            System.Windows.Media.RenderOptions.SetBitmapScalingMode(rtb, System.Windows.Media.BitmapScalingMode.HighQuality);\n            rtb.Render(dv);\n            rtb.Freeze();\n            return rtb;\n        }\n\n        // 共通：三角（Start）／四角（Stop）\n        public static Media.ImageSource BuildTriangleIcon(int sizePx, Media.Color fill, Media.Color stroke)\n        {\n            var dv = new Media.DrawingVisual();\n            using (var dc = dv.RenderOpen())\n            {\n                DrawPlate(dc, sizePx);\n\n                double pad = sizePx * 0.25;\n                var p1 = new System.Windows.Point(pad, pad * 0.8);\n                var p2 = new System.Windows.Point(sizePx - pad * 0.8, sizePx / 2.0);\n                var p3 = new System.Windows.Point(pad, sizePx - pad * 0.8);\n\n                var geo = new Media.StreamGeometry();\n                using (var ctx = geo.Open())\n                {\n                    ctx.BeginFigure(p1, true, true);\n                    ctx.LineTo(p2, true, false);\n                    ctx.LineTo(p3, true, false);\n                }\n                geo.Freeze();\n\n                var fillBrush = new Media.SolidColorBrush(fill);\n                var penBrush = new Media.SolidColorBrush(stroke);\n                var pen = new Media.Pen(penBrush, Math.Max(1, sizePx * 0.05));\n                fillBrush.Freeze(); penBrush.Freeze(); pen.Freeze();\n\n                dc.DrawGeometry(fillBrush, pen, geo);\n            }\n            return ToBitmap(dv, sizePx);\n        }\n\n        public static Media.ImageSource BuildSquareIcon(int sizePx, Media.Color fill, Media.Color stroke)\n        {\n            var dv = new Media.DrawingVisual();\n            using (var dc = dv.RenderOpen())\n            {\n                DrawPlate(dc, sizePx);\n\n                double pad = sizePx * 0.26;\n                var rect = new System.Windows.Rect(pad, pad, sizePx - pad * 2, sizePx - pad * 2);\n\n                var fillBrush = new Media.SolidColorBrush(fill);\n                var penBrush = new Media.SolidColorBrush(stroke);\n                var pen = new Media.Pen(penBrush, Math.Max(1, sizePx * 0.05));\n                fillBrush.Freeze(); penBrush.Freeze(); pen.Freeze();\n\n                dc.DrawRoundedRectangle(fillBrush, pen, rect, sizePx * 0.08, sizePx * 0.08);\n            }\n            return ToBitmap(dv, sizePx);\n        }\n\n        // 新規：フォルダアイコン（Developer パネル用）\n        public static Media.ImageSource BuildFolderIcon(int sizePx, bool isLogs = false)\n        {\n            var dv = new Media.DrawingVisual();\n            using (var dc = dv.RenderOpen())\n            {\n                DrawPlate(dc, sizePx);\n\n                double pad = sizePx * 0.16;\n                var topH = sizePx * 0.26;           // タブ部分の高さ\n                var bodyTop = pad + topH * 0.6;     // 本体開始位置\n\n                // タブ\n                var tabRect = new System.Windows.Rect(pad, pad, sizePx * 0.50, topH);\n                var tabFill = new Media.SolidColorBrush(isLogs ? Media.Color.FromRgb(255, 196, 120) : Media.Color.FromRgb(255, 230, 140));\n                var tabStroke = new Media.SolidColorBrush(Media.Color.FromRgb(170, 130, 70));\n                var tabPen = new Media.Pen(tabStroke, Math.Max(1, sizePx * 0.04));\n                tabFill.Freeze(); tabStroke.Freeze(); tabPen.Freeze();\n                dc.DrawRoundedRectangle(tabFill, tabPen, tabRect, sizePx * 0.06, sizePx * 0.06);\n\n                // 本体\n                var bodyRect = new System.Windows.Rect(pad, bodyTop, sizePx - pad * 2, sizePx - bodyTop - pad);\n                var bodyFill = new Media.LinearGradientBrush(\n                    isLogs ? Media.Color.FromRgb(255, 180, 90) : Media.Color.FromRgb(255, 210, 110),\n                    isLogs ? Media.Color.FromRgb(240, 150, 60) : Media.Color.FromRgb(240, 185, 90),\n                    90);\n                var bodyStroke = new Media.SolidColorBrush(Media.Color.FromRgb(170, 130, 70));\n                var bodyPen = new Media.Pen(bodyStroke, Math.Max(1, sizePx * 0.04));\n                bodyStroke.Freeze(); bodyPen.Freeze();\n                dc.DrawRoundedRectangle(bodyFill, bodyPen, bodyRect, sizePx * 0.08, sizePx * 0.08);\n\n                // ログ用の「doc」っぽいマーク\n                if (isLogs)\n                {\n                    var paper = new System.Windows.Rect(bodyRect.X + bodyRect.Width * 0.60, bodyRect.Y + bodyRect.Height * 0.18, bodyRect.Width * 0.28, bodyRect.Height * 0.60);\n                    var paperFill = new Media.SolidColorBrush(Media.Color.FromRgb(255, 255, 255));\n                    var paperPen = new Media.Pen(new Media.SolidColorBrush(Media.Color.FromRgb(180, 180, 180)), Math.Max(1, sizePx * 0.03));\n                    (paperFill as Media.SolidColorBrush).Freeze();\n                    (paperPen.Brush as Media.SolidColorBrush)!.Freeze(); paperPen.Freeze();\n                    dc.DrawRoundedRectangle(paperFill, paperPen, paper, sizePx * 0.02, sizePx * 0.02);\n                }\n            }\n            return ToBitmap(dv, sizePx);\n        }\n\n        private static void DrawPlate(System.Windows.Media.DrawingContext dc, int sizePx)\n        {\n            var plate = new Media.LinearGradientBrush(Media.Color.FromRgb(245, 245, 245), Media.Color.FromRgb(220, 220, 220), 90);\n            var border = new Media.Pen(new Media.SolidColorBrush(Media.Color.FromRgb(180, 180, 180)), Math.Max(1, sizePx * 0.04));\n            plate.Freeze(); border.Freeze();\n\n            dc.DrawRoundedRectangle(plate, border, new System.Windows.Rect(0.5, 0.5, sizePx - 1, sizePx - 1), sizePx * 0.18, sizePx * 0.18);\n        }\n\n        private static Imaging.RenderTargetBitmap ToBitmap(Media.DrawingVisual dv, int sizePx)\n        {\n            var rtb = new Imaging.RenderTargetBitmap(sizePx, sizePx, 96, 96, Media.PixelFormats.Pbgra32);\n            System.Windows.Media.RenderOptions.SetBitmapScalingMode(rtb, System.Windows.Media.BitmapScalingMode.HighQuality);\n            rtb.Render(dv);\n            rtb.Freeze();\n            return rtb;\n        }\n    }\n}\n\n
