# グリッド間寸法作成手順書

## 1. 目的

Revitビュー上に、隣接するグリッド間の寸法を自動で作成し、指定された位置に配置します。

## 2. 前提条件

*   Revitが起動しており、Revit MCPサーバーが動作していること。
*   Revitプロジェクト内にグリッドが配置されており、その情報が `grids.json` ファイルに保存されていること。
*   Revitアドインがグリッドに対する寸法作成に対応していること。
*   寸法を作成する平面図ビューが存在すること。存在しない場合は、事前に作成する必要があります。

## 3. 手順

### 3.1. 平面図ビューの準備

寸法は平面図ビューにのみ作成できます。既存の平面図ビューを使用するか、新しい平面図ビューを作成します。

#### 3.1.1. 新しい平面図ビューの作成 (既存ビューがない場合)

1.  **Revitのレベル情報を取得**:
    ```bash
    python %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\Python\Scripts/Reference/send_revit_command_durable.py --port 5210 --command get_levels --params "{}"
    ```
    出力されるレベル情報から、平面図ビューを作成したいレベルの名前（例: "1FL"）を確認します。

2.  **平面図ビューの作成**:
    取得したレベル名を使用して、新しい平面図ビューを作成します。
    ```bash
    python %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\Python\Scripts/Reference/send_revit_command_durable.py --port 5210 --command create_view_plan --params "{\"name\": \"Gemini_1F_Plan\", \"levelName\": \"1FL\"}"
    ```
    このコマンドの実行結果から、作成されたビューの `elementId` を控えておきます（例: `279830`）。

### 3.2. グリッド間の寸法作成

グリッド間の寸法を作成します。この際、グリッドの `elementId` を参照として使用します。

1.  **グリッド情報の確認**:
    `grids.json` ファイルにグリッドの `elementId` が含まれていることを確認します。
    ```bash
    type %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\grids.json
    ```
    （例: X1の `elementId` は `279520`、X2の `elementId` は `279529` など）

2.  **寸法タイプIDの選択**:
    グリッド間の寸法作成に適した寸法タイプIDを選択します。
    ```bash
    python %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\Python\Scripts/Reference/send_revit_command_durable.py --port 5210 --command get_dimension_types --params "{}"
    ```
    出力の中から、`style: "Linear"` で、かつ適切な名前のタイプを選択します。本手順書では `typeId: 261` ("点線 - 2.5 mm") を使用します。

3.  **寸法作成スクリプトの実行**:
    以下のPythonスクリプトを `temp_create_dimensions_for_grids.py` として保存し、実行します。
    このスクリプトは、`grids.json` からグリッドIDを取得し、隣接するグリッド間に寸法を作成します。

    ```python
    import json
    import os
    import sys
    # Scripts/Reference/send_revit_command_durable.py があるディレクトリをパスに追加
    sys.path.append(os.path.join('%USERPROFILE%\\Documents\\Revit_MCP\\GeminiCLI', 'Python'))
    from send_revit_command import send_revit_request

    view_id = 279830 # ここに作成した平面図ビューのIDを設定
    dimension_type_id = 261 # ここに選択した寸法タイプIDを設定
    port = 5210

    # グリッド名からelementIdを取得するための辞書
    grid_name_to_element_id = {
        "X1": 279520, "X2": 279529, "X3": 279530, "X4": 279531, "X5": 279532, "X6": 279522,
        "Y1": 279521, "Y2": 279534, "Y3": 279535, "Y4": 279523
    }

    # X方向のグリッドペア
    x_grid_pairs = [
        ("X1", "X2"), ("X2", "X3"), ("X3", "X4"), ("X4", "X5"), ("X5", "X6")
    ]

    # Y方向のグリッドペア
    y_grid_pairs = [
        ("Y1", "Y2"), ("Y2", "Y3"), ("Y3", "Y4")
    ]

    def create_dimension_for_pair(grid_name1, grid_name2):
        element_id1 = grid_name_to_element_id[grid_name1]
        element_id2 = grid_name_to_element_id[grid_name2]

        command_name = "create_dimension"
        params = {
            "viewId": view_id,
            "typeId": dimension_type_id,
            "refs": [element_id1, element_id2]
        }

        print(f"Creating dimension for {grid_name1}-{grid_name2} (Element IDs: {element_id1}, {element_id2})...")
        try:
            result = send_revit_request(port, command_name, params)
            if result.get("ok"):
                dimension_id = result.get("elementId")
                print(f"  Successfully created dimension for {grid_name1}-{grid_name2}. Dimension ID: {dimension_id}")
                return dimension_id
            else:
                print(f"  Failed to create dimension for {grid_name1}-{grid_name2}: {result.get('error', 'Unknown error')}")
        except Exception as e:
            print(f"  Error creating dimension for {grid_name1}-{grid_name2}: {e}")
        return None

    # X方向の寸法を作成
    print("--- Creating X-direction dimensions ---")
    x_dimension_ids = []
    for pair in x_grid_pairs:
        dim_id = create_dimension_for_pair(pair[0], pair[1])
        if dim_id:
            x_dimension_ids.append(dim_id)

    # Y方向の寸法を作成
    print("\n--- Creating Y-direction dimensions ---")
    y_dimension_ids = []
    for pair in y_grid_pairs:
        dim_id = create_dimension_for_pair(pair[0], pair[1])
        if dim_id:
            y_dimension_ids.append(dim_id)

    print("\nDimension creation process completed.")
    print(f"X-direction dimension IDs: {x_dimension_ids}")
    print(f"Y-direction dimension IDs: {y_dimension_ids}")

    # 作成した寸法IDを保存（後で移動などに使用）
    all_dimension_ids = {"x_dims": x_dimension_ids, "y_dims": y_dimension_ids}
    with open("%USERPROFILE%\\Documents\\Revit_MCP\\GeminiCLI/created_grid_dimensions.json", "w", encoding="utf-8") as f:
        json.dump(all_dimension_ids, f, indent=2, ensure_ascii=False)
    ```

    実行コマンド:
    ```bash
    python %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\temp_create_dimensions_for_grids.py
    ```
    この実行により、`created_grid_dimensions.json` ファイルに作成された寸法線のIDが保存されます。

### 3.3. 寸法線の配置調整

作成された寸法線を、指定された位置（Y=-3m、X=-3m）に移動します。

1.  **寸法移動スクリプトの実行**:
    以下のPythonスクリプトを `temp_move_dimensions.py` として保存し、実行します。
    このスクリプトは、作成された寸法線の現在の位置を取得し、目標位置までの移動量を計算して `move_dimension` コマンドで移動します。

    ```python
    import json
    import os
    import sys
    # Scripts/Reference/send_revit_command_durable.py があるディレクトリをパスに追加
    sys.path.append(os.path.join('%USERPROFILE%\\Documents\\Revit_MCP\\GeminiCLI', 'Python'))
    from send_revit_command import send_revit_request

    port = 5210
    view_id = 279830 # ここに平面図ビューのIDを設定

    # 作成された寸法IDを読み込む
    with open("%USERPROFILE%\\Documents\\Revit_MCP\\GeminiCLI/created_grid_dimensions.json", "r", encoding="utf-8") as f:
        created_dims = json.load(f)

    # ビュー内の全ての寸法情報を取得
    print("Getting all dimensions in view to determine current positions...")
    try:
        result = send_revit_request(port, "get_dimensions_in_view", {"viewId": view_id})
        if result.get("ok"):
            all_dimensions_in_view = result.get("dimensions", [])
            print("Successfully retrieved current dimension positions.")
        else:
            print(f"Failed to get dimensions in view: {result.get('error', 'Unknown error')}")
            sys.exit(1)
    except Exception as e:
        print(f"Error getting dimensions in view: {e}")
        sys.exit(1)

    # 寸法IDと現在のorigin座標のマッピングを作成
    dimension_origins = {dim['elementId']: dim['origin'] for dim in all_dimensions_in_view}

    # X方向の寸法線を移動
    print("\n--- Moving X-direction dimensions ---")
    target_y = -3000.0 # mm
    for dim_id in created_dims['x_dims']:
        current_origin = dimension_origins.get(dim_id)
        if current_origin:
            dy = target_y - current_origin['y']
            # dx, dz は0
            dx = 0.0
            dz = 0.0

            command_name = "move_dimension"
            params = {
                "elementId": dim_id,
                "dx": dx,
                "dy": dy,
                "dz": dz
            }
            print(f"Moving X-dimension ID {dim_id} from Y={current_origin['y']} to Y={target_y} (dy={dy})...")
            try:
                move_result = send_revit_request(port, command_name, params)
                if move_result.get("ok"):
                    print(f"  Successfully moved dimension ID: {dim_id}")
                else:
                    print(f"  Failed to move dimension ID: {dim_id}: {move_result.get('error', 'Unknown error')}")
            except Exception as e:
                print(f"  Error moving dimension ID: {dim_id}: {e}")
        else:
            print(f"Warning: Origin not found for X-dimension ID {dim_id}. Skipping move.")

    # Y方向の寸法線を移動
    print("\n--- Moving Y-direction dimensions ---")
    target_x = -3000.0 # mm
    for dim_id in created_dims['y_dims']:
        current_origin = dimension_origins.get(dim_id)
        if current_origin:
            dx = target_x - current_origin['x']
            # dy, dz は0
            dy = 0.0
            dz = 0.0

            command_name = "move_dimension"
            params = {
                "elementId": dim_id,
                "dx": dx,
                "dy": dy,
                "dz": dz
            }
            print(f"Moving Y-dimension ID {dim_id} from X={current_origin['x']} to X={target_x} (dx={dx})...")
            try:
                move_result = send_revit_request(port, command_name, params)
                if move_result.get("ok"):
                    print(f"  Successfully moved dimension ID: {dim_id}")
                else:
                    print(f"  Failed to move dimension ID: {dim_id}: {move_result.get('error', 'Unknown error')}")
            except Exception as e:
                print(f"  Error moving dimension ID: {dim_id}: {e}")
        else:
            print(f"Warning: Origin not found for Y-dimension ID {dim_id}. Skipping move.")

    print("\nDimension movement process completed.")
    ```

    実行コマンド:
    ```bash
    python %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\temp_move_dimensions.py
    ```

## 4. クリーンアップ

作業完了後、作成した一時ファイルを削除します。

```bash
del %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\temp_create_dimensions_for_grids.py %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\created_grid_dimensions.json %USERPROFILE%\Documents\Revit_MCP\GeminiCLI\temp_move_dimensions.py
```







