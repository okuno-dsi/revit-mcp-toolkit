# 環境設定と接続確認

## 1. 概要
このドキュメントでは、Revitアドインが正しく動作しているかを確認し、基本的な接続テストを行う手順を説明します。
最も基本的なテストとして、現在開いているプロジェクトの情報を取得する `get_open_documents` コマンドを実行します。

**【重要: IDの取り扱いについて】**
Revit要素の識別には、`Element ID`（整数値）と`Unique ID`（GUID文字列）の2種類があります。`Unique ID`はプロジェクト間で一意であり、より堅牢な識別子として推奨されます。

## 2. 前提条件
-   Revitが起動しており、対象のプロジェクトファイルが開かれていること。
-   Revit MCPアドインがロードされ、サーバーが動作していること。
-   `Manuals/Scripts/send_revit_command_durable.py` スクリプトが利用可能であること。

## 3. 接続テストの実行

### 3.1. コマンド
`get_open_documents` コマンドは、現在Revitで開かれているすべてのドキュメント（ホストとリンク）の情報を返します。

**実行コマンド:** 
```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command get_open_documents
```
-   `--port`: 必要に応じて、Revitアドインが動作しているポート番号に変更してください。

### 3.2. 実行結果の確認
コマンドが成功すると、以下のようなJSON形式のデータが出力されます。`"ok": true` と、開いているドキュメントの情報が含まれていれば、接続は正常です。

**出力例:**
```json
{
  "ok": true,
  "count": 2,
  "documents": [
    {
      "title": "サンプル構造",
      "path": "C:\\...\\サンプル構造.rvt",
      "projectName": "サンプル構造",
      "isLinked": true,
      "role": "link",
      "uniqueId": "doc-unique-id-linked"
    },
    {
      "title": "サンプル意匠",
      "path": "C:\\...\\サンプル意匠.rvt",
      "projectName": "サンプル意匠",
      "isLinked": false,
      "role": "host",
      "uniqueId": "doc-unique-id-host"
    }
  ],
  "issues": {
    "failures": [],
    "dialogs": []
  }
}
```

サーバー稼働確認用の ping_server コマンド
{"method":"ping_server","desc":"Check if the MCP server is running.","params_example":{},"result_example":{"ok":true,"msg":"MCP Server is running"}}

## 4. トラブルシューティング
-   `ConnectionRefusedError` やタイムアウトエラーが発生した場合、Revitが起動しているか、アドインが正しくロードされているか、また指定したポート番号が正しいかを確認してください。

-   `"ok": false` が返された場合は、Revitアドイン側でエラーが発生しています。Revitのダイアログやログを確認してください。

## 5. 【最重要】文字化けを確実に防ぐためのコマンド実行方法 (Windows)

Windows環境で `Manuals/Scripts/send_revit_command_durable.py` を実行し、日本語を含むJSON結果をファイルに保存する際に、深刻な文字化け問題が発生します。これを回避するには、以下のルールを**絶対に守ってください**。

### 根本原因
Windowsのコマンドプロンプトが使うデフォルトの文字コード（cp932）と、プログラムが期待する文字コード（UTF-8）が異なるためです。

### 禁止事項：リダイレクト(`>`)の使用
以下のコマンドは、**絶対に実行しないでください**。リダイレクト演算子 `>` を使うと、出力ファイルが `cp932` でエンコードされ、100%文字化けします。

```bash
# 間違い：この方法は必ず文字化けを引き起こす
python Python/Manuals/Scripts/send_revit_command_durable.py --command get_rooms > rooms.json  # 絶対に禁止！
```

### 唯一の正しい方法：`--output-file` オプションの使用
文字化けを防ぐ、唯一の信頼できる方法は、`Manuals/Scripts/send_revit_command_durable.py` の `--output-file` オプションを使用することです。これにより、スクリプトが直接UTF-8でファイルを書き込むため、エンコーディングの問題を完全に回避できます。

**正しいコマンドの例:**
```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command get_rooms --output-file C:\Users\user\path\to\rooms.json
```

パラメータを渡す必要がある場合は、`--params-file` オプションを併用します。

**パラメータファイルを使った正しいコマンドの例:**
```bash
# 1. パラメータをJSONファイルとして用意する (例: params.json)
# {"skip": 0, "count": 5000}

# 2. コマンドを実行する
python Python/Manuals/Scripts/send_revit_command_durable.py ^
    --port 5210 ^
    --command get_walls ^
    --params-file C:\path\to\params.json ^
    --output-file C:\path\to\walls.json
```

**このルールは、日本語データを含む可能性のあるすべてのコマンド実行に適用されます。徹底してください。**


