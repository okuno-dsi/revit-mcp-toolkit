# マス操作手順書 (v2 - 実践ワークフロー強化版)

## 1. 概要
このドキュメントでは、Revitモデル内のマス要素を作成・操作する手順を説明します。マスはコンセプトデザインやボリュームスタディに不可欠です。この手順書では、以下の2つの主要な作成方法を解説します。

1.  **ファミリから配置:** 事前に定義されたマスファミリを配置する基本的な方法。
2.  **形状から作成:** 部屋など、既存の要素の境界形状を基に、カスタム形状のマスを押し出して作成する実践的な方法。

---

## 2.【最重要】IDの取り扱いについて

API操作の成功は、**対象要素のIDを正確に特定すること**が絶対条件です。IDの特定を誤ると、意図しない要素を操作したり、エラーが多発したりします。

マス操作を行う前に、必ず別紙の **「Revit要素IDの正確な特定手順書」** を熟読し、正しい手順でIDを取得してください。

---

## 3. 方法1: ファミリからマスを配置

この方法は、Revitにロード済みのマスファミリ（例：「ボックス」）を、指定したレベルにインスタンスとして配置します。

- **主要コマンド:** `create_mass_instance`
- **特徴:** レベルとの関連付けが簡単に行えます。

### パラメータ例
```json
{
  "location": {"x": 8563.774, "y": 9546.32, "z": 0.0}, // mm単位
  "levelId": 49173, // 配置したいレベルのID
  "typeId": 60455968 // 配置したいマスファミリのタイプID
}
```

### 実行例
```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command create_mass_instance --params "{\"location\":...}"
```

---

## 4. 方法2: 部屋などの形状からマスを作成 (実践)

部屋の正確なフットプリントと高さを持つマスを作成する、より高度で実践的なワークフローです。

### 目的
部屋のボリュームを正確に表現するマスを作成し、視覚化や他の検討に利用します。

### 主要コマンド
- `get_room_boundary`: 部屋の境界形状（2Dの頂点リスト）を取得します。
- `get_room_params`: 部屋の高さパラメータを取得します。
- `create_direct_shape_mass`: 2Dの頂点リストを押し出してマス形状を作成します。
- `move_mass_instance`: 作成したマスの位置を修正します。

### 実行ワークフロー

#### ステップ1: 部屋のID、境界、高さを正確に取得

1.  **ID特定:** 「Revit要素IDの正確な特定手順書」に従い、対象の部屋の `elementId` を特定します。
2.  **境界取得:** `get_room_boundary` を実行し、部屋の境界線を構成する頂点データ (`segments`) を取得します。
3.  **高さ取得:** `get_room_params` を実行し、「部屋高さ(レベル指定)」などのパラメータからマスの高さとなる値を取得します。

#### ステップ2: マスの作成 (`create_direct_shape_mass`)

取得した境界線の頂点リストと高さを使い、マスを作成します。

- **コマンド:** `create_direct_shape_mass`
- **パラメータ例:**
  ```json
  {
    "loops": [[ {"x": 848704.9, "y": 95896.3}, ... ]], // get_room_boundaryで得た頂点リスト(x,yのみ)
    "height": 2800.0, // get_room_paramsで得た高さ
    "useMassCategory": true
  }
  ```

#### ステップ3: レベルの不一致と位置修正

**【非常に重要な注意点】**
`create_direct_shape_mass` コマンドは、指定された絶対座標に形状を作成しますが、**Revitの特定のレベルに要素を関連付けません。** そのため、作成されたマスは、意図した高さからずれた位置（通常はZ=0）に配置されます。

これを修正するため、以下の手順でマスを正しい高さに移動させる必要があります。

1.  **正しい高さを確認:** `get_room_boundary` の結果に含まれる頂点の **`z` 座標の値**を確認します。これが、部屋が配置されている床面の高さ（マスの移動先Z座標）になります。（例: `12650.0` mm）

2.  **マスをZ方向に移動:** `move_mass_instance` コマンドを使い、作成したマスを正しい高さまで移動させます。

    - **コマンド:** `move_mass_instance`
    - **パラメータ例:**
      ```json
      {
        "elementId": 63987763, // 作成されたマスのID
        "dx": 0.0,
        "dy": 0.0,
        "dz": 12650.0 // 手順1で確認した部屋のZ座標
      }
      ```

この手順により、部屋と完全に一致した位置と形状のマスが作成されます。

---

## 5. その他のマス操作

以下のコマンドは、上記いずれの方法で作成したマスにも適用できます。

- **`get_mass_instances`**: モデル内の全マス要素を取得します。
- **`delete_mass_instance`**: 指定したマスを削除します。
- **`update_mass_instance_parameter`**: マスのインスタンスパラメータを更新します。
- **`get_mass_types` / `duplicate_mass_type`**: マスファミリのタイプを管理します。（方法1で作成したマスに関連）
