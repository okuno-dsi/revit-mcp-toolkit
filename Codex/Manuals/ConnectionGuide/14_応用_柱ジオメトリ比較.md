# 手順書: 2つのRevitプロジェクト間での構造柱ジオメトリ比較

## 1. 目的

プロジェクト固有の命名規則（ID、レベル名、タイプ名など）に依存せず、2つのRevitプロジェクト間で構造柱の純粋な「ジオメトリ情報（位置と形状）」の差異を特定し、結果をCSVファイルとRevit上の3Dビューで可視化する。

**【重要: IDの取り扱いについて】**
Revit要素の識別には、`Element ID`（整数値）と`Unique ID`（GUID文字列）の2種類があります。`Unique ID`はプロジェクト間で一意であり、より堅牢な識別子として推奨されます。Revit MCPアドインは、`Unique ID`が提供された場合、自動的に対応する`Element ID`に変換して処理する機能を備えています。可能な限り`Unique ID`の使用を優先してください。

## 2. 課題と解決策

- **課題:** プロジェクト間で命名規則が異なるため、名前での単純比較はできない。
- **解決策:** 以下の情報を用いて比較する。
    - **位置:** XYZの3次元座標（許容誤差あり）
    - **形状:** ユーザーが指定したタイプパラメータ（例: `幅`と`高さ`）

## 3. 必要なスクリプト

- `get_columns_info.py`: 柱インスタンスの位置情報を取得
- `collect_all_type_params.py`: 柱タイプの全パラメータ情報を収集
- `compare_columns.py`: ジオメトリを比較し、差分ファイルを出力（デバッグ情報付き）
- `color_elements.py`: Revit上で結果を色分け表示

## 4. 実行手順

### ステップ0: 事前準備

比較したい2つのRevitプロジェクトを、それぞれ異なるポート（例: 5210, 5211）で起動しておく。

### ステップ1: 柱インスタンス情報の取得

各プロジェクトから、全構造柱のインスタンス情報（`Element ID`, `Unique ID`, `typeId`, XYZ座標）を取得し、ファイルに保存する。**要素の識別には、`Unique ID`を優先して使用することを推奨します。**

```shell
# プロジェクト1 (ポート5210)
python Python/get_columns_info.py --port 5210 --output columns_5210.json

# プロジェクト2 (ポート5211)
python Python/get_columns_info.py --port 5211 --output columns_5211.json
```

### ステップ2: 柱タイプ情報の取得

各プロジェクトで実際に使用されている柱タイプの詳細なパラメータ情報を収集する。`collect_all_type_params.py`は、`Element ID`と`Unique ID`の両方でタイプ情報を収集します。**タイプ識別には、`Unique ID`を優先して使用することを推奨します。**

```shell
# プロジェクト1 (ポート5210)
python collect_all_type_params.py --port 5210 --instances_file columns_5210.json --output column_types_5210.json

# プロジェクト2 (ポート5211)
python collect_all_type_params.py --port 5211 --instances_file columns_5211.json --output column_types_5211.json
```

### ステップ3: ジオメトリ比較と差分ファイルの生成

収集した4つのJSONファイルを基に、最終的なジオメトリ比較を実行する。

```shell
python compare_columns.py ^
    --instances1 columns_5210.json ^
    --types1 column_types_5210.json ^
    --instances2 columns_5211.json ^
    --types2 column_types_5211.json
```
これにより、以下のファイルが生成される。
- `column_differences.csv`: 相違点の詳細リスト。
- `color_map_5210.json` / `color_map_5211.json`: 色分け用のIDリスト。

### ステップ4: 結果の確認と視覚化 (オプション)

`column_differences.csv` を開いて差分を確認する。
必要に応じて、Revit上で結果を色分け表示する。`color_elements.py`は、`Element ID`または`Unique ID`を含むカラーマップファイルを使用して要素を着色できます。**`Unique ID`の使用を推奨します。**

```shell
# プロジェクト1 (ポート5210) - 相違点を青色で表示
python Python/color_elements.py --port 5210 --color_map color_map_5210.json --color blue

# プロジェクト2 (ポート5211) - 相違点を赤色で表示
python Python/color_elements.py --port 5211 --color_map color_map_5211.json --color red
```

---

## 5. AIへの重要注意事項

**この手順を再度実行する際は、以下の点を厳守すること。**

1.  **パラメータ名の確認:**
    柱の「形状」を比較するために使用する**タイプパラメータ名**（本件では `STC_Dx`/`STC_Dy` と `幅`/`高さ`）は、プロジェクトごとに異なる可能性が非常に高い。
    もし、これらのパラメータ名が不明な場合は、**決して安易な推測（例: `typeName` からの寸法抽出）をせず、必ずユーザーに「どのパラメータで形状を比較すべきか」を明確に質問すること。**

2.  **IDの取り扱い（Unique IDの優先）:**
    Revit要素の識別には`Element ID`と`Unique ID`の2種類があります。特に複数プロジェクト間での比較や、Revitモデルのバージョンアップを考慮する場合、`Unique ID`はプロジェクト間で一意であり、より堅牢な識別子として推奨されます。スクリプトの引数として`Unique ID`が利用可能な場合は、積極的に`Unique ID`を使用してください。

3.  **デバッグ情報の活用:**
    `compare_columns.py` には、比較ロジックの途中経過を出力するデバッグ機能が意図的に残されている。もし比較結果が想定と異なる場合（例: CSVが空になる、など）は、まずこのスクリプトを実行し、コンソールのデバッグ出力を分析して原因を特定すること。

