# 壁の基準線からエリア境界線を作成する手順書

## 1. 概要

この手順書は、Revitプロジェクト内の部屋の境界となる壁の基準線（LocationCurve）から、エリア境界線を作成する方法を説明します。

Revitの標準機能では、特定の壁の基準線だけをトレースしてエリア境界線を作成することは直接サポートされていません。この手順書では、複数のPythonスクリプトとRevit MCPアドインのコマンドを連携させることで、この複雑なタスクを実現します。

## 2. 前提条件

- Revitがポート5210で稼働しており、対象のプロジェクトが開かれていること。
- 対象となる部屋と壁がプロジェクト内に存在すること。
- エリアプランが作成済みであること（例: 「レベル 1 床面積」エリアプランのビューID `279492`）。
- `Python/Manuals/Scripts/send_revit_command_durable.py` スクリプトが正しく配置されていること。

## 3. 手順

### Step 1: 部屋のIDを取得

プロジェクト内のすべての部屋のIDを取得し、後続の処理で使用します。

```bash
python Python\Manuals/Scripts/send_revit_command_durable.py --port 5210 --command get_rooms --output-file all_rooms_for_boundary.json
```

### Step 2: 部屋の境界壁のIDを抽出

Step 1で取得した部屋のIDをもとに、各部屋の境界となる壁のIDを抽出し、重複を排除したリストを作成します。

**スクリプトの作成 (`extract_room_boundary_walls.py`):**
```python
import json
import os
import subprocess
import time
import sys

def run_revit_command(port, command, params=None, temp_id=0):
    script_path = os.path.join('Python', 'Manuals/Scripts/send_revit_command_durable.py')
    params_file = f'temp_params_{command}_{temp_id}.json'
    result_file = f'temp_result_{command}_{temp_id}.json'
    
    cmd_list = [
        'python',
        script_path,
        '--port', str(port),
        '--command', command,
        '--output-file', result_file
    ]

    if params:
        with open(params_file, 'w', encoding='utf-8') as pf:
            json.dump(params, pf)
        cmd_list.extend(['--params-file', params_file])

    try:
        subprocess.run(cmd_list, check=True, capture_output=True, text=True, encoding='utf-8')
        with open(result_file, 'r', encoding='utf-8') as rf:
            return json.load(rf)
    except (subprocess.CalledProcessError, FileNotFoundError, json.JSONDecodeError) as e:
        print(f"エラー: コマンド '{command}' の実行中にエラーが発生しました。\n{e}", file=sys.stderr)
        return None
    finally:
        if os.path.exists(params_file):
            os.remove(params_file)
        if os.path.exists(result_file):
            os.remove(result_file)

def extract_room_boundary_walls():
    port = 5210
    all_wall_ids = set()

    try:
        with open('all_rooms_for_boundary.json', 'r', encoding='utf-8') as f:
            rooms_data = json.load(f)
    except FileNotFoundError:
        print("エラー: all_rooms_for_boundary.json が見つかりません。", file=sys.stderr)
        return

    rooms = rooms_data.get('rooms', [])
    if not rooms:
        print("all_rooms_for_boundary.json に部屋が含まれていません。")
        return

    print(f"{len(rooms)}件の部屋の境界壁を抽出します...")

    for i, room in enumerate(rooms):
        room_id = room.get('elementId')
        room_name = room.get('name', '不明な部屋')

        if not room_id:
            print(f"警告: {i+1}番目の部屋データにelementIdがありません。スキップします。")
            continue

        print(f"  {i+1}/{len(rooms)}: 部屋 '{room_name}' (ID: {room_id}) の境界壁を取得中...")

        params = {'elementId': room_id}
        result = run_revit_command(port, 'get_room_boundary_walls', params, f"room_boundary_{room_id}")

        if result and result.get('ok') and result.get('wallIds'):
            for wall_id in result['wallIds']:
                all_wall_ids.add(wall_id)
            print(f"    -> 成功: {len(result['wallIds'])}件の壁IDを抽出しました。")
        else:
            error_msg = result.get('error', '不明なエラー') if result else 'コマンド実行失敗'
            print(f"    -> 警告: 部屋ID {room_id} の境界壁の取得に失敗しました。\n       応答: {error_msg}", file=sys.stderr)
        time.sleep(0.2) # サーバー負荷軽減

    # 重複を排除したリストとして保存
    output_list = sorted(list(all_wall_ids))
    output_file_path = 'room_boundary_wall_ids.json'
    with open(output_file_path, 'w', encoding='utf-8') as f:
        json.dump(output_list, f, indent=2, ensure_ascii=False)

    print(f"\n重複のない境界壁IDのリストを {output_file_path} に保存しました。")
    print(f"合計 {len(output_list)}件のユニークな壁IDを検出しました。")

if __name__ == '__main__':
    extract_room_boundary_walls()
```

**スクリプトの実行:**
```bash
python extract_room_boundary_walls.py
```

### Step 3: 壁の基準線情報を取得

Step 2で抽出した壁のIDをもとに、各壁の基準線（始点と終点座標）を取得します。

**スクリプトの作成 (`get_wall_location_curves.py`):**
```python
import json
import os
import subprocess
import time
import sys

def run_revit_command(port, command, params=None, temp_id=0):
    script_path = os.path.join('Python', 'Manuals/Scripts/send_revit_command_durable.py')
    params_file = f'temp_params_{command}_{temp_id}.json'
    result_file = f'temp_result_{command}_{temp_id}.json'
    
    cmd_list = [
        'python',
        script_path,
        '--port', str(port),
        '--command', command,
        '--output-file', result_file
    ]

    if params:
        with open(params_file, 'w', encoding='utf-8') as pf:
            json.dump(params, pf)
        cmd_list.extend(['--params-file', params_file])

    try:
        subprocess.run(cmd_list, check=True, capture_output=True, text=True, encoding='utf-8')
        with open(result_file, 'r', encoding='utf-8') as rf:
            return json.load(rf)
    except (subprocess.CalledProcessError, FileNotFoundError, json.JSONDecodeError) as e:
        print(f"エラー: コマンド '{command}' の実行中にエラーが発生しました。\n{e}", file=sys.stderr)
        return None
    finally:
        if os.path.exists(params_file):
            os.remove(params_file)
        if os.path.exists(result_file):
            os.remove(result_file)

def get_wall_location_curves():
    port = 5210
    
    try:
        with open('room_boundary_wall_ids.json', 'r', encoding='utf-8') as f:
            target_wall_ids = set(json.load(f)) # ターゲットとなる壁IDのセット
    except FileNotFoundError:
        print("エラー: room_boundary_wall_ids.json が見つかりません。", file=sys.stderr)
        return

    if not target_wall_ids:
        print("room_boundary_wall_ids.json に壁IDが含まれていません。")
        return

    print(f"{len(target_wall_ids)}件のターゲット壁の基準線情報を取得します...")

    # get_walls でプロジェクト内のすべての壁を取得
    # count=0 でメタデータのみ取得し、totalCount を利用してページングする
    meta_result = run_revit_command(port, 'get_walls', {'count': 0}, "walls_meta")
    if not meta_result or not meta_result.get('ok'):
        print("エラー: 壁メタデータの取得に失敗しました。", file=sys.stderr)
        return
    
    total_walls = meta_result.get('totalCount', 0)
    if total_walls == 0:
        print("プロジェクトに壁がありません。", file=sys.stderr)
        return

    all_walls_data = []
    batch_size = 500 # 一度に取得する壁の数
    for skip in range(0, total_walls, batch_size):
        print(f"  壁データを取得中: {skip}件目から{batch_size}件...", file=sys.stderr)
        walls_result = run_revit_command(port, 'get_walls', {'skip': skip, 'count': batch_size}, f"walls_batch_{skip}")
        if walls_result and walls_result.get('ok') and walls_result.get('walls'):
            all_walls_data.extend(walls_result['walls'])
        else:
            print(f"警告: 壁データバッチの取得に失敗しました (skip={skip})。", file=sys.stderr)
            
    if not all_walls_data:
        print("エラー: 壁データを取得できませんでした。", file=sys.stderr)
        return

    location_curves = []
    for wall in all_walls_data:
        if wall.get('elementId') in target_wall_ids:
            # get_walls の結果には start/end が直接含まれる
            start_point = wall.get('start')
            end_point = wall.get('end')
            
            if start_point and end_point:
                location_curves.append({
                    'elementId': wall['elementId'],
                    'uniqueId': wall['uniqueId'],
                    'start': start_point,
                    'end': end_point
                })
            else:
                print(f"警告: 壁ID {wall.get('elementId')} の開始点または終了点が見つかりませんでした。スキップします。", file=sys.stderr)

    output_file_path = 'wall_location_curves.json'
    with open(output_file_path, 'w', encoding='utf-8') as f:
        json.dump(location_curves, f, indent=2, ensure_ascii=False)

    print(f"壁の基準線情報を {output_file_path} に保存しました。")
    print(f"合計 {len(location_curves)}件の基準線情報を検出しました。")

if __name__ == '__main__':
    get_wall_location_curves()
```

**スクリプトの実行:**
```bash
python get_wall_location_curves.py
```

### Step 4: エリア境界線を作成

Step 3で取得した壁の基準線情報をもとに、エリア境界線を作成します。このスクリプトは、作成済みのエリアプランビュー（例: 「レベル 1 床面積」）に境界線を描画します。

**スクリプトの作成 (`create_area_boundaries_from_curves.py`):**
```python
import json
import os
import subprocess
import time
import sys

def run_revit_command(port, command, params=None, temp_id=0):
    script_path = os.path.join('Python', 'Manuals/Scripts/send_revit_command_durable.py')
    params_file = f'temp_params_{command}_{temp_id}.json'
    result_file = f'temp_result_{command}_{temp_id}.json'
    
    cmd_list = [
        'python',
        script_path,
        '--port', str(port),
        '--command', command,
        '--output-file', result_file
    ]

    if params:
        with open(params_file, 'w', encoding='utf-8') as pf:
            json.dump(params, pf)
        cmd_list.extend(['--params-file', params_file])

    try:
        subprocess.run(cmd_list, check=True, capture_output=True, text=True, encoding='utf-8')
        with open(result_file, 'r', encoding='utf-8') as rf:
            return json.load(rf)
    except (subprocess.CalledProcessError, FileNotFoundError, json.JSONDecodeError) as e:
        print(f"エラー: コマンド '{command}' の実行中にエラーが発生しました。\n{e}", file=sys.stderr)
        return None
    finally:
        if os.path.exists(params_file):
            os.remove(params_file)
        if os.path.exists(result_file):
            os.remove(result_file)

def create_area_boundaries_from_curves():
    port = 5210
    area_plan_view_id = 279492 # 「レベル 1 床面積」エリアプランのビューID

    try:
        with open('wall_location_curves.json', 'r', encoding='utf-8') as f:
            location_curves = json.load(f)
    except FileNotFoundError:
        print("エラー: wall_location_curves.json が見つかりません。", file=sys.stderr)
        return

    if not location_curves:
        print("wall_location_curves.json に基準線情報が含まれていません。")
        return

    print(f"{len(location_curves)}件のエリア境界線を作成します...")

    for i, curve in enumerate(location_curves):
        start_point = curve.get('start')
        end_point = curve.get('end')
        element_id = curve.get('elementId', '不明')

        if not all([start_point, end_point]):
            print(f"警告: {i+1}番目の基準線データに開始点または終了点がありません。スキップします。", file=sys.stderr)
            continue

        print(f"  {i+1}/{len(location_curves)}: 壁ID {element_id} のエリア境界線を作成中...")

        params = {
            'viewId': area_plan_view_id,
            'start': start_point,
            'end': end_point
        }
        result = run_revit_command(port, 'create_area_boundary_line', params, f"area_boundary_{element_id}")

        if result and result.get('ok'):
            created_id = result.get('elementId', '不明')
            print(f"    -> 成功: エリア境界線が作成されました。 (ID: {created_id})")
        else:
            error_msg = result.get('error', '不明なエラー') if result else 'コマンド実行失敗'
            print(f"    -> エラー: エリア境界線の作成に失敗しました。\n       応答: {error_msg}", file=sys.stderr)
        time.sleep(0.1) # サーバー負荷軽減

    print("エリア境界線の作成が完了しました。")

if __name__ == '__main__':
    create_area_boundaries_from_curves()
```

**スクリプトの実行:**
```bash
python create_area_boundaries_from_curves.py
```

