# 06_基本操作_壁の作成

この手順書は、RevitのMCPサーバーを通じて壁を作成する方法を説明します。

**【重要: IDの取り扱いについて】**
Revit要素の識別には、`Element ID`（整数値）と`Unique ID`（GUID文字列）の2種類があります。`Unique ID`はプロジェクト間で一意であり、より堅牢な識別子として推奨されます。Revit MCPアドインは、`Unique ID`が提供された場合、自動的に対応する`Element ID`に変換して処理する機能を備えています。可能な限り`Unique ID`の使用を推奨します。

## 1. 目的

Revitビュー上に、指定した位置、タイプ、レベル拘束で壁を作成します。

## 2. 前提条件

*   Revitが起動しており、MCPアドインがロードされていること。
*   Python環境がセットアップされており、`requests` ライブラリがインストールされていること。
*   `Python/Manuals/Scripts/send_revit_command_durable.py` スクリプトが利用可能であること。
*   壁タイプおよびレベルの情報が事前に取得されていること。

## 3. 必要な情報の取得

壁を作成する前に、利用可能な壁タイプとレベルの情報を取得します。

### 3.1. 壁タイプの一覧取得

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command get_wall_types
```

### 3.2. レベル情報の一覧取得

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command get_levels
```

## 4. 壁の作成 (`create_wall` コマンド)

`create_wall` コマンドは、壁の始点と終点、壁タイプ、およびレベル拘束を指定して壁を作成します。

### コマンドパラメータ

*   `start` (必須): 壁の始点座標 (x, y, z)。単位はmm。
*   `end` (必須): 壁の終点座標 (x, y, z)。単位はmm。
*   `wallTypeId` (必須): 作成する壁のタイプID。
*   `baseLevelId` / `baseLevelName` / `levelId` / `levelName` (必須): 壁の基準レベルを指定します。いずれか一つを指定。
*   `topLevelId` / `topLevelName` (任意): 壁の上部拘束レベルを指定します。指定がない場合、`heightMm` の設定に従います。
*   `heightMm` (任意): 壁の高さの指定方法。
    *   **数値 (mm)**: 壁の高さ（Unconnected Height）をmmで指定します。この場合、`topLevelId`/`topLevelName` が未指定であれば、壁は非拘束（Unconnected）となります。
    *   **`"level-to-level"` (文字列)**: 壁の基準レベルから直上レベルまで上部拘束されます。`topLevelId`/`topLevelName` が指定されていれば、そちらが優先されます。
    *   **未指定**: `"level-to-level"` と同じ動作になります。
*   `baseOffsetMm` (任意): 基準レベルからのオフセット量 (mm)。既定値は0。
*   `topOffsetMm` (任意): 上部拘束レベルからのオフセット量 (mm)。既定値は0。

### 4.1. 使用例: 特定の高さの壁を作成 (非拘束)

1FL (levelId: 279461) に、高さ3000mmの非拘束な壁を作成します。

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command create_wall --params "{\"start\":{\"x\":0.0,\"y\":0.0,\"z\":0.0},\"end\":{\"x\":5000.0,\"y\":0.0,\"z\":0.0},\"baseLevelId\":279461,\"wallTypeId\":103484,\"heightMm\":3000}"
```

### 4.2. 使用例: レベル間拘束の壁を作成 (直上階まで)

1FL (levelId: 279461) から直上階（2FL）まで拘束される壁を作成します。
`heightMm` を`"level-to-level"`と明示的に指定するか、省略します。

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command create_wall --params "{\"start\":{\"x\":0.0,\"y\":10000.0,\"z\":0.0},\"end\":{\"x\":5000.0,\"y\":10000.0,\"z\":0.0},\"baseLevelId\":279461,\"wallTypeId\":103484,\"heightMm\":\"level-to-level\"}"
```

### 4.3. 使用例: 特定のレベル間拘束の壁を作成 (topLevel指定)

1FL (levelId: 279461) からRFL (levelId: 279483) まで拘束される壁を作成します。

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command create_wall --params "{\"start\":{\"x\":0.0,\"y\":20000.0,\"z\":0.0},\"end\":{\"x\":5000.0,\"y\":20000.0,\"z\":0.0},\"baseLevelId\":279461,\"wallTypeId\":103484,\"topLevelId\":279483}"
```

### 4.4. 使用例: オフセット付きの壁を作成

1FL (levelId: 279461) から2FL (levelId: 279472) まで拘束され、基準レベルから100mm、上部レベルから-50mmオフセットされる壁を作成します。

```bash
python Python/Manuals/Scripts/send_revit_command_durable.py --port 5210 --command create_wall --params "{\"start\":{\"x\":0.0,\"y\":30000.0,\"z\":0.0},\"end\":{\"x\":5000.0,\"y\":30000.0,\"z\":0.0},\"baseLevelId\":279461,\"wallTypeId\":103484,\"topLevelId\":279472,\"baseOffsetMm\":100,\"topOffsetMm\":-50}"
```

## 5. Pythonスクリプトの利用

壁作成のロジックをまとめた汎用的なPythonスクリプト `Python/create_wall_with_options.py` を利用することもできます。このスクリプトは、壁の始点、終点、壁タイプ、基準レベル、上部レベル、高さ、オフセットなどを引数として受け取り、`create_wall` コマンドを実行します。

### `Python/create_wall_with_options.py` の内容

```python
import json
import os
import sys
import argparse

sys.path.append(os.path.join(os.path.dirname(__file__), 'Python')) # Manuals/Scripts/send_revit_command_durable.py があるディレクトリをパスに追加
from send_revit_command import send_revit_request

def create_wall_with_options(
    port,
    start_x, start_y, start_z,
    end_x, end_y, end_z,
    wall_type_id,
    base_level_id=None, base_level_name=None,
    top_level_id=None, top_level_name=None,
    height_mm=None,
    base_offset_mm=0,
    top_offset_mm=0
):
    params = {
        "start": {"x": start_x, "y": start_y, "z": start_z},
        "end": {"x": end_x, "y": end_y, "z": end_z},
        "wallTypeId": wall_type_id
    }

    if base_level_id is not None: params["baseLevelId"] = base_level_id
    elif base_level_name is not None: params["baseLevelName"] = base_level_name

    if top_level_id is not None: params["topLevelId"] = top_level_id
    elif top_level_name is not None: params["topLevelName"] = top_level_name

    if height_mm is not None: params["heightMm"] = height_mm

    if base_offset_mm != 0: params["baseOffsetMm"] = base_offset_mm
    if top_offset_mm != 0: params["topOffsetMm"] = top_offset_mm

    print(f"Creating wall with params: {params}")
    try:
        result = send_revit_request(port, "create_wall", params)
        if result.get("ok"):
            wall_id = result.get("elementId")
            print(f"Successfully created wall. Element ID: {wall_id}")
            return wall_id
        else:
            print(f"Failed to create wall: {result.get('error', 'Unknown error')}")
    except Exception as e:
        print(f"Error creating wall: {e}")
    return None

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Create a wall in Revit with various options.")
    parser.add_argument("--port", type=int, default=5210, help="Port number of the Revit instance.")
    parser.add_argument("--start_x", type=float, required=True)
    parser.add_argument("--start_y", type=float, required=True)
    parser.add_argument("--start_z", type=float, default=0.0)
    parser.add_argument("--end_x", type=float, required=True)
    parser.add_argument("--end_y", type=float, required=True)
    parser.add_argument("--end_z", type=float, default=0.0)
    parser.add_argument("--wall_type_id", type=int, required=True)
    parser.add_argument("--base_level_id", type=int, help="Base level ID.")
    parser.add_argument("--base_level_name", type=str, help="Base level name.")
    parser.add_argument("--top_level_id", type=int, help="Top level ID.")
    parser.add_argument("--top_level_name", type=str, help="Top level name.")
    parser.add_argument("--height_mm", type=str, help="Wall height in mm or 'level-to-level'.")
    parser.add_argument("--base_offset_mm", type=float, default=0.0)
    parser.add_argument("--top_offset_mm", type=float, default=0.0)

    args = parser.parse_args()

    # height_mm が数値の場合、floatに変換
    if args.height_mm and args.height_mm.replace('.', '', 1).isdigit():
        height_val = float(args.height_mm)
    else:
        height_val = args.height_mm

    create_wall_with_options(
        port=args.port,
        start_x=args.start_x, start_y=args.start_y, start_z=args.start_z,
        end_x=args.end_x, end_y=args.end_y, end_z=args.end_z,
        wall_type_id=args.wall_type_id,
        base_level_id=args.base_level_id,
        base_level_name=args.base_level_name,
        top_level_id=args.top_level_id,
        top_level_name=args.top_level_name,
        height_mm=height_val,
        base_offset_mm=args.base_offset_mm,
        top_offset_mm=args.top_offset_mm
    )
```

### `Python/create_wall_with_options.py` の使用例

1FLから2FLまで拘束される壁を作成します。

```bash
python Python/create_wall_with_options.py \
    --port 5210 \
    --start_x 0.0 --start_y 0.0 --start_z 0.0 \
    --end_x 5000.0 --end_y 0.0 --end_z 0.0 \
    --wall_type_id 103484 \
    --base_level_id 279461 \
    --top_level_id 279472 \
    --height_mm "level-to-level"
```

## 6. Pythonスクリプトの整理と削除

壁作成に関連する既存のスクリプトを整理し、不要な一時ファイルを削除します。

### 6.1. 既存スクリプトの確認と改定

`Python` フォルダ内の壁作成に関連するスクリプト（例: `change_wall_type.py`, `update_wall_types_by_line.py` など）を確認し、必要に応じて新しい壁作成方法を反映させます。

### 6.2. 一時ファイルの削除

今回の作業で作成された一時ファイルは、手動で削除してください。

*   `temp_create_4_walls_v2.py`
*   `created_4_walls_v2.json`
*   `temp_create_walls_level_to_level.py`
*   `created_walls_level_to_level.json`
*   `temp_offset_walls_level_to_level.py`
*   `temp_create_dimension_between_walls_level_to_level.py`

```bash
del C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\temp_create_4_walls_v2.py \
    C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\created_4_walls_v2.json \
    C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\temp_create_walls_level_to_level.py \
    C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\created_walls_level_to_level.json \
    C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\temp_offset_walls_level_to_level.py \
    C:\Users\okuno\Documents\VS2022\Ver101\GeminiCLI\temp_create_dimension_between_walls_level_to_level.py
```

