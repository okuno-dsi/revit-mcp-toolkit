# get_candidate_exterior_walls

- カテゴリ: Walls（壁）
- 目的: 「外壁候補」と思われる壁要素を一括で取得します。  
  壁の基準線（LocationCurve）と Room 情報にもとづいて、片側だけが「室内ボリューム」に接している壁を外壁候補として抽出します。

## 概要
現在のプロジェクト内の壁を（必要に応じてビュー・レベルで絞り込みつつ）走査し、  
各壁の LocationCurve 上の複数点について、壁の法線方向（`Wall.Orientation`）に沿って両側へサンプル点を取り、  
それぞれが「床または屋根に上下を挟まれた Room 内部ボリューム」に含まれるかどうかを判定します。  
同じ壁の基準線上で、「一方の側だけが室内ボリュームに含まれ、反対側は含まれない」状態が一方向に限って現れる場合、  
その壁を「外壁候補」として扱います。

このコマンド自体は読み取り専用で、代表的な用途は次のようなものです。
- 「この建物の外壁候補の ID を全部教えて」
- 「外壁候補だけ仕上・塗装を解析したいので、対象集合を先に絞り込みたい」

## 使い方
- メソッド名: `get_candidate_exterior_walls`

### パラメータ
```jsonc
{
  "viewId": 123456,            // 任意, int
  "levelId": 200001,           // 任意, int
  "levelIds": [200001,200002], // 任意, int[]
  "minExteriorAreaM2": 1.0,    // 任意, double (既定 1.0)
  "roomCheck": true,           // 任意, bool (既定 true)
  "offsetMm": 1000.0           // 任意, double (既定 1000.0)
}
```

- `viewId` (int, 任意)  
  指定した場合、そのビューで見えている壁のみを対象にします。
- `levelId` (int, 任意)  
  単一レベルでの絞り込みです。`LevelId` がこの ID の壁のみ対象になります。
- `levelIds` (int[], 任意)  
  複数レベルによる絞り込みです。配列が空でなければ `levelId` より優先されます。  
  `LevelId` がこの配列に含まれる壁のみ対象になります。
- `minExteriorAreaM2` (double, 任意, 既定値 `1.0`)  
  外壁候補として扱う最低の外部面積 (m²) です。  
  面積は、外壁候補と判定された壁について「基準線長さ × 壁高さ」をもとに近似的に算出されます。
- `roomCheck` (bool, 任意, 既定値 `true`)  
  `true` の場合、Room を使って内外判定を行います（Level/BaseOffset/UpperLimit などから上下方向の範囲も推定します）。  
  `false` の場合、Room 情報を使った判定を行わず、このコマンドは実質的に外壁候補を返さなくなります。
- `offsetMm` (double, 任意, 既定値 `1000.0`)  
  Room ベース判定の際にフェイス法線方向にオフセットする距離 (mm) です。  
  内部では mm からフィートへ変換し、  
  - `pOut = p + n * offsetFt`  
  - `pIn  = p - n * offsetFt`  
  の 2 点をサンプルして Room 内外を判定します。

## 戻り値
```jsonc
{
  "ok": true,
  "msg": null,
  "totalCount": 24,
  "walls": [
    {
      "elementId": 6799522,
      "id": 6799522,
      "uniqueId": "f8f6455a-...",
      "levelId": 200001,
      "typeId": 310001,
      "typeName": "EX-200mm Concrete",
      "exteriorAreaM2": 42.37
    }
  ],
  "inputUnits": {
    "Length": "mm",
    "Area": "m2",
    "Volume": "m3",
    "Angle": "deg"
  },
  "internalUnits": {
    "Length": "ft",
    "Area": "ft2",
    "Volume": "ft3",
    "Angle": "rad"
  }
}
```

- `ok` (bool): コマンド全体として成功したかどうか。  
- `msg` (string|null): 追加メッセージ。条件に合う壁が 0 件の場合は「条件に該当する壁がありません。」などが入る場合があります。
- `totalCount` (int): `walls` に含まれる外壁候補の件数。
- `walls` (array): 外壁候補の壁一覧（幾何と Room に基づく候補セット）。
  - `elementId` / `id`: 壁要素の `ElementId`（int）。
  - `uniqueId`: Revit の `UniqueId` 文字列。
  - `levelId`: 対応レベルの `ElementId`（不明な場合は 0）。
  - `typeId`: 壁タイプの `ElementId`。
  - `typeName`: 壁タイプの名前。
  - `exteriorAreaM2`: 外部側面積の近似値 (m², 端数は丸め)。  
    実装上は「基準線長さ × 壁高さ」をもとに計算されます。

## 補足

- モデルは一切変更せず、壁の基準線・バウンディングボックス・Room 情報のみを読み取ります。
- 判定ロジックは **壁タイプ名や ShellLayerType には依存せず**、あくまで幾何情報と Room に基づくヒューリスティックです。
- `exteriorAreaM2` は「基準線長さ × 壁高さ」による近似であり、厳密なフェイス面積の合計ではありません。
- このコマンドは、あくまで「外壁候補のあたりをつけるための概略手法」として設計されています。
  - 直線的で単純な建物では、実務上十分な精度が得られることが多いです。
  - 凹凸の多い複雑なファサードや、中庭・吹き抜け・外構が入り組んだ不整形な建物では、
    誤判定（内部壁を外壁候補とする／外壁を取りこぼす）の確率が高くなります。
  - 部屋が配置されていないシャフト・煙突・パイプスペース周りの壁は、Room モデルの仕方によって結果が左右されます。
- 高い正確性が必要なワークフローでは、このコマンドの結果をそのまま採用せず、
  - 結果をレポートやビュー上の色分けで可視化し、
  - プロジェクト固有のルール（タイプ名、設計者の意図など）と組み合わせて人間が確認・補正する
  という使い方を推奨します。
