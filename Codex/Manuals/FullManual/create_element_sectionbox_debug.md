# create_element_sectionbox_debug

- Category: ViewOps / Debug
- Purpose: Experimental command for creating section views (`ViewFamily.Section`) around arbitrary elements, and returning detailed debug information about the SectionBox transform and bounds.

## Overview
This command is intended for **debugging and prototyping** section-box logic. It attempts to build a `BoundingBoxXYZ` + `Transform` suitable for `ViewSection.CreateSection`, without falling back to elevation views.

If a section view cannot be created (e.g., Revit throws an `ArgumentException`), the command still returns diagnostic data (`worldBounds`, `localBounds`, `viewBasis`) in the `skipped` array to help you understand why.

> NOTE: This command is experimental and not guaranteed to succeed for all elements, especially complex curtain walls. Use it as a tool to refine SectionBox strategies rather than as a production feature.

## Usage

- Method: `create_element_sectionbox_debug`

### Parameters

| Name              | Type    | Required | Default | Description |
|-------------------|---------|----------|---------|-------------|
| `elementIds`      | int[]   | no       |         | Ids of elements to debug. Optional when `fromSelection=true`. |
| `fromSelection`   | bool    | no       | false   | If true and `elementIds` is empty, uses the current Revit selection. |
| `offsetDistance_mm` | number | no      | 1500    | How far (mm) to place the section plane in front of the element’s bounding box center along the view direction. |
| `cropMargin_mm`   | number  | no       | 200     | Margin (mm) to expand around the element’s projected bounding box in X/Y/Z. |
| `viewScale`       | int     | no       | 50      | Scale for the created section view. |

### Example Request

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "create_element_sectionbox_debug",
  "params": {
    "fromSelection": true,
    "offsetDistance_mm": 1500,
    "cropMargin_mm": 200,
    "viewScale": 50
  }
}
```

### Success Result Example

```jsonc
{
  "ok": true,
  "msg": "Created 1 section view(s).",
  "items": [
    {
      "ok": true,
      "elementId": 6801576,
      "viewId": 11130001,
      "viewName": "DbgSection_6801576",
      "worldBounds": {
        "min": { "x_ft": 1.52, "y_ft": 40.0, "z_ft": 0.0, "x_mm": 465.0, "y_mm": 12192.0, "z_mm": 0.0 },
        "max": { "x_ft": 5.46, "y_ft": 45.0, "z_ft": 20.0, "x_mm": 1665.0, "y_mm": 13716.0, "z_mm": 6100.0 }
      },
      "localBounds": {
        "min": { "x_ft": -2.0, "y_ft": 0.0, "z_ft": 0.0, "x_mm": -610.0, "y_mm": 0.0, "z_mm": 0.0 },
        "max": { "x_ft": 2.0, "y_ft": 6.0, "z_ft": 4.0, "x_mm": 610.0, "y_mm": 1829.0, "z_mm": 1219.0 }
      },
      "viewBasis": {
        "origin": { "x_ft": 3.5, "y_ft": 38.0, "z_ft": 10.0, "x_mm": 1067.0, "y_mm": 11582.0, "z_mm": 3048.0 },
        "dir":   { "x": 0.0, "y": 1.0, "z": 0.0 },
        "up":    { "x": 0.0, "y": 0.0, "z": 1.0 },
        "right": { "x": 1.0, "y": 0.0, "z": 0.0 }
      }
    }
  ],
  "skipped": []
}
```

### Failure / TODO Example

```jsonc
{
  "ok": false,
  "msg": "Created 0 section view(s).",
  "items": [],
  "skipped": [
    {
      "elementId": 6801576,
      "reason": "ArgumentException",
      "debug": {
        "worldBounds": { "min": { /* ... */ }, "max": { /* ... */ } },
        "localBounds": { "min": { /* ... */ }, "max": { /* ... */ } },
        "viewBasis": {
          "origin": { /* ... */ },
          "dir": { "x": 0.0, "y": 1.0, "z": 0.0 },
          "up":  { "x": 0.0, "y": 0.0, "z": 1.0 },
          "right": { "x": 1.0, "y": 0.0, "z": 0.0 }
        }
      }
    }
  ]
}
```

## Current Limitations and TODOs

- The command:
  - Uses a simple global view direction (+Y) and builds an orthonormal basis (Right/Up/Dir) for the section.
    - IMPORTANT: the basis must be **right-handed** (`BasisX × BasisY = BasisZ`) or `ViewSection.CreateSection` may throw.
  - Projects the element’s world bounding box into this basis and adds margins in X/Y/Z.
  - Normalizes the local Z range so that `Min.Z = 0` and `Max.Z = depth` (with a minimum depth of 10mm) before calling `ViewSection.CreateSection`.
- Despite this, Revit can still throw `ArgumentException` for certain elements (e.g., curtain walls with complex geometry), meaning the SectionBox definition is not yet satisfying all internal constraints of the API.

Planned improvements:

- Compare SectionBox definitions generated by this command with those of hand-made Revit section views to identify the exact constraints (e.g., basis orientation, depth range, or category-specific behaviors).
- Integrate more robust element-based orientation (similar to door/window elevation logic) so that the section plane aligns more naturally with walls, doors, and curtain walls.
- This logic is also used by `create_element_elevation_views` when `mode="SectionBox"` (with fallback to `"ElevationMarker"` if section creation fails).

For now, prefer using `"ElevationMarker"` mode and the door/window cropping enhancements for production workflows, and reserve `create_element_sectionbox_debug` for troubleshooting and research.
